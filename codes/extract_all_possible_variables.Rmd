---
title: "R Notebook"
output: html_notebook
---

# Load packages which can read in docx or pdf files directly.

```{r, message=FALSE}
library(readtext)
library(antiword)
library(tidyverse)
library(ggplot2)
library(textreadr)
library(stringi)
library(textclean)
library(SemNetCleaner)
library(readxl)
```

# import .docx in r and extract all variables

```{r}
word <- readtext("../data/combine/word/all_variables_inWord.docx")
# extract text part
text <- word[1,2]
# split the while string by \n character
variables <- strsplit(text, split = "\n")[[1]]
length(variables)
variable <- unique(variables)
```

# Get the count/frequency of all variables
```{r}
# tibble(variables) %>%
#   count(variables) %>%
#   ggplot(aes(x = reorder(variables, -n), y = n)) +
#   geom_col() +
#   theme(axis.text.x = element_text(angle = 90))
```

# The frequency of variables
```{r}
# tibble(variables) %>%
#   count(variables) %>%
#   arrange(desc(n))
```

```{r}
#combine <- readtext("../data/combine/word/combine_word.docx")$text
```

```{r}
# regexec("Parties and states of incorporation", combine)
# str_extract_all(combine, "Parties and states of incorporation")
```

# Read in all deals as a data frame
```{r}
all <- readtext(file = "/Users/liyuan/Dropbox/George\ RA\ Li\ Yuan\ work/all_docx/all_docx")
dim(all)
```

```{r}
#all[grep(".KKR.", all[,1])[1], 2]
```

# Show first 6 rows
```{r}
#head(all)
```

# Find frequency of all variables
```{r}
# fre <- rep(0, length(variable))
# for(i in seq_along(variable)){
#   vab <- gsub("(", "\\(", variable[i], fixed = T)
#   vab <- gsub(")", "\\)", vab, fixed = T)
#   for(j in 1:dim(all)[1]){
#     fre[i] <- fre[i] + length(str_match_all(string = all[j,2], pattern = vab)[[1]])
#   }
# }
```

# Form a table and write out to save
```{r}
# fre_table <- data.frame(variable, fre)
# write.csv(x = fre_table, file = "Counts of all potential variables(71).csv", row.names = F, col.names = T)
# write_csv(x = fre_table, file = "Counts of all potential variables(71).csv")
# total <- sum(fre_table$fre)
```

# Plot this frequency table
```{r}
# fre_table %>%
#   ggplot(aes(x = reorder(variable, -fre), y = fre)) +
#   geom_col(fill = "red", color = "black", width = .85) +
#   scale_y_continuous(name = "Counts", sec.axis = sec_axis(trans = ~./total, name = "Frequency")) + 
#   labs(x = "Column Name", y = "Counts", title = "Frequency/Counts of all potential variables(71)") +
#   theme_minimal() +
#   theme(axis.text.x = element_text(angle = 90, face = "bold", size = 11),
#         axis.text.y = element_text(face = "bold", size = 14),
#         axis.text.y.right = element_text(face = "bold", size = 18, color = "red"),
#         plot.title = element_text(hjust = .5, size = 30),
#         axis.title = element_text(size = 20, face = "italic"),
#         axis.title.y.right = element_text(size = 23, face = 4, color = "blue"),
#         panel.background = element_rect(fill = "khaki1", color = "white", major.grid),
#         panel.grid = element_line(color = "green3"),
#         panel.grid.minor = element_blank()) 
# ggsave("Frequency\\Counts of all potential variables(71).png", width = 70, height = 30, units = "cm")
```

# Find all apearance frequency among documents(deals)
```{r}
# doc_fre <- rep(0, length(variable))
# for(i in seq_along(variable)){
#   vab <- gsub("(", "\\(", variable[i], fixed = T)
#   vab <- gsub(")", "\\)", vab, fixed = T)
#   for(j in 1:dim(all)[1]){
#     doc_fre[i] <- doc_fre[i] + grepl(pattern = vab, x = all[j,2])
#   }
# }
```

# Save this table
```{r}
# doc_table <- data.frame(variable, doc_fre)
# write.csv(x = doc_table, file = "Counts of appearance in documents(3365) of all potential variables(71).csv", row.names = F, col.names = T)
# write_csv(x = doc_table, file = "Counts of appearance in documents(3365) of all potential variables(71).csv")
# num_doc <- dim(all)[1]
```

# Plot this frequency
```{r}
# doc_table %>%
#   ggplot(aes(x = reorder(variable, -doc_fre), y = doc_fre)) +
#   geom_col(fill = "red", color = "black", width = .85) +
#   scale_y_continuous(name = "Counts", sec.axis = sec_axis(trans = ~./num_doc, name = "Frequency")) + 
#   labs(x = "Column Name", y = "Counts", title = "Frequency/Counts of appearance in documents(3365) of all potential variables(71)") +
#   theme_minimal() +
#   theme(axis.text.x = element_text(angle = 90, face = "bold", size = 12),
#         axis.text.y = element_text(face = "bold", size = 16),
#         axis.text.y.right = element_text(face = "bold", size = 19, color = "red"),
#         plot.title = element_text(hjust = .5, size = 30),
#         axis.title = element_text(size = 20, face = "italic"),
#         axis.title.y.right = element_text(size = 23, face = 4, color = "blue"),
#         panel.background = element_rect(fill = "khaki1", color = "white", major.grid),
#         panel.grid = element_line(color = "green3"),
#         panel.grid.minor = element_blank()) 
# ggsave("Frequency\\Counts of appearance in documents(3365) of all potential variables(71).png", width = 70, height = 30, units = "cm")
```

# estalish database for deals

## Extract Parties and states of incorporation inside columns
```{r}
set_all <- c()
for(i in 1:dim(all)[1]){
  starting <- regexpr("Parties and states of incorporation", all[i,2])
  rest <- variable[variable != "Parties and states of incorporation"]
  ending_ma <- rep(0, length(rest))
  ending_ma <- data.frame(rest, ending_ma)
  for(j in seq_along(rest)){ ending_ma[j,2] <- regexpr(rest[j], all[i,2], fixed = T) }
  ending_ma <- ending_ma[ending_ma$ending_ma > starting, ]
  ending <- ending_ma %>% slice_min(ending_ma) %>% pull(ending_ma)
  
  text <- substr(all[i,2], start = starting + 36, stop = ending - 2)
  #strsplit(text, split = "\n")
  set <- str_match_all(text, pattern = "\n(.+?):")[[1]][,2]
  set_all <- c(set, set_all)
}

# unique of all potential variables
uni_inside <- unique(set_all)
```

## Count and frequency of all potential variables

```{r}
fre_table_party <- data.frame(uni_inside, fre = 0)
for(i in 1:dim(all)[1]){
  starting <- regexpr("Parties and states of incorporation", all[i,2])
  rest <- variable[variable != "Parties and states of incorporation"]
  ending_ma <- rep(0, length(rest))
  ending_ma <- data.frame(rest, ending_ma)
  for(j in seq_along(rest)){ ending_ma[j,2] <- regexpr(rest[j], all[i,2], fixed = T) }
  ending_ma <- ending_ma[ending_ma$ending_ma > starting, ]
  ending <- ending_ma %>% slice_min(ending_ma) %>% pull(ending_ma)
  text <- substr(all[i,2], start = starting + nchar(variable[1]), stop = ending - 2)
  # above code is to extract text between parties
  
  #set <- str_match_all(text, pattern = "\n(.+?):")[[1]][,2]
  for(q in seq(uni_inside)){
    if(grepl(paste0(" ", uni_inside[q], ":"), text, fixed = T)
       |
       grepl(paste0("\n", uni_inside[q], ":"), text, fixed = T)){
      fre_table_party[q,2] <- fre_table_party[q,2] + 1
    }
  }
}

fre_table_party <- fre_table_party %>% arrange(desc(fre))
write.csv(x = fre_table_party %>% arrange(desc(fre)), file = "Frequency of party types.csv")
```

## Extract plural party typies

```{r}
plural_party <- uni_inside[grep(pattern = "s$", x = uni_inside)]
```

## count max number of each plural party type

```{r}
fre_plural_party <- data.frame(plural_party, n = 1)
for(i in 1:dim(all)[1]){
  #i = 1
  starting <- regexpr("Parties and states of incorporation", all[i,2])
  rest <- variable[variable != "Parties and states of incorporation"]
  ending_ma <- rep(0, length(rest))
  ending_ma <- data.frame(rest, ending_ma)
  for(j in seq_along(rest)){ ending_ma[j,2] <- regexpr(rest[j], all[i,2], fixed = T) }
  ending_ma <- ending_ma[ending_ma$ending_ma > starting, ]
  ending <- ending_ma %>% slice_min(ending_ma) %>% pull(ending_ma)
  text <- substr(all[i,2], start = starting + nchar(variable[1]), stop = ending - 2)
  text <- paste0(text, "#")
  # Extract party text
  #set <- str_match_all(text, pattern = "\n(.+?):")[[1]][,2]
  set <- c()
  for(q in seq(plural_party)){
    #q = 227
    if(grepl(paste0(" ", plural_party[q], ":"), text, fixed = T)
       |
       grepl(paste0("\n", plural_party[q], ":"), text, fixed = T)){ set <- c(set, plural_party[q]) }}
  
  for(q in seq(plural_party)){ 
    #q = 1
    if(plural_party[q] %in% set){
      # res <- regexec(paste0("\n", plural_party[q], ":", "(.+?)", "(", paste0(set, collapse = ":|"), ":|#)"), text)[[1]]
      # st <- res[2]
      # so <- attr(res, "match.length")[2] + st -1
      # field <- substr(text, st, so)
      starting <- regexpr(paste0(plural_party[q], ":"), text)
      rest <- set[set != plural_party[q]]
      ending_ma <- rep(0, length(rest))
      ending_ma <- data.frame(rest, ending_ma)
      for(j in seq_along(rest)){ ending_ma[j,2] <- regexpr(paste0(rest[j], ":"), text, fixed = T) }
      ending_ma <- ending_ma[ending_ma$ending_ma > starting, ]
      ending <- ending_ma %>% slice_min(ending_ma) %>% pull(ending_ma)
      if(length(ending) == 1){
      field <- substr(text, start = starting + nchar(plural_party[q]) + 1, stop = ending - 1)
      } else {
        field <- substr(text, start = starting + nchar(plural_party[q]) + 1, nchar(text))
      }
      #field
      num_and <- length(str_match_all(field, " and ")[[1]])
      loc <- str_match_all(field, "\\((.+?)\\)")[[1]]
      num_loc <- length(loc[,2])
      true_and <- num_and - sum(grepl(" and ", loc[,2], fixed = T))
      if(true_and >= 1) {
        new <- max(2, length(str_match_all(field, "\\((.+?)\\)")[[1]]))
        if(new > fre_plural_party[q, 2]) {fre_plural_party[q, 2] <- new}
      }
    }
  }
}

fre_plural_party <- fre_plural_party %>% arrange(desc(n))
```

## Separate plural

```{r}
plural_party_having2more_entities <- fre_plural_party %>% filter(n > 1) %>% arrange(desc(n))
plural_party_having1entities <- fre_plural_party %>% filter(n == 1) %>% arrange(desc(n))
write_csv(x = plural_party_having2more_entities, file = "plural_party_having2more_entities.csv")
write_csv(x = plural_party_having1entities, file = "plural_party_having1entities.csv")
```

## Check Minority Sellers

```{r}
# for(i in 1:dim(all)[1]){
#   starting <- regexpr("Parties and states of incorporation", all[i,2])
#   rest <- variable[variable != "Parties and states of incorporation"]
#   ending_ma <- rep(0, length(rest))
#   ending_ma <- data.frame(rest, ending_ma)
#   for(j in seq_along(rest)){ ending_ma[j,2] <- regexpr(rest[j], all[i,2], fixed = T) }
#   ending_ma <- ending_ma[ending_ma$ending_ma > starting, ]
#   ending <- ending_ma %>% slice_min(ending_ma) %>% pull(ending_ma)
#   
#   text <- substr(all[i,2], start = starting + nchar(variable[1]), stop = ending - 2)
#   set <- str_match_all(text, pattern = "\n(.+?):")[[1]][,2]
#   if("Principals" %in% set) {
#     print(all[i,1])
#     }
# }
```

## Remove all singlarity party types which appear in plural with 2 more entities table

```{r}
single <- generics::setdiff(fre_table_party$uni_inside, fre_plural_party$plural_party)
final_party <- fre_plural_party$plural_party
for(i in 1:length(single)){
  if(!(make_plural(single[i]) %in% fre_plural_party$plural_party)){
    final_party <- c(final_party, single[i])
  }
}

party_fre_final <- data.frame(party = final_party) %>%
  left_join(fre_plural_party, by = c("party" = "plural_party"))

party_fre_final$n <- ifelse(is.na(party_fre_final$n), 1, party_fre_final$n)
```

## Create party table

```{r}
party <- party_fre_final %>%
  mutate(con_p := case_when(
    substr(party, nchar(party)-2, nchar(party)) == "ies" ~ gsub("ies", "y", party, fixed = T),
    substr(party, nchar(party), nchar(party)) == "s" ~ substr(party, 1, nchar(party)-1),
    TRUE ~ party
    )
) %>%
  select(party_c = con_p, party, n)
View(party)
```

## Create party column name

```{r}
# party_col <- c()
# for(i in 1:nrow(party)){
#   if(party[i, "n"] > 1){
#     for(j in 1:party[i, "n"]) {
#       party_col <- c(party_col, paste0(party[i, 1], j), paste0(paste0(party[i, 1], j), "_location"))
#     }
#     party_col <- c(party_col, paste0(party[i, 1], "_note"))
#   } else{
#     party_col <- c(party_col, party[i, 1], paste0(paste0(party[i, 1], "_location")) )
#     party_col <- c(party_col, paste0(party[i, 1], "_note"))
#   }
# }

party_col <- c()
for(i in 1:nrow(party)){
    for(j in 1:party[i, "n"]) {
      party_col <- c(party_col, paste0(party[i, 1], j), paste0(paste0(party[i, 1], j), "_location"))
    }
      party_col <- c(party_col, paste0(party[i, 1], "_note"))
}
length(party_col)
```

Plot this frequency
```{r}
# fre_table_party %>%
#   filter(fre > 10) %>%
#   ggplot(aes(x = reorder(uni_inside, -fre), y = fre)) +
#   geom_col(fill = "red", color = "black", width = .7) +
#   scale_y_continuous(name = "Counts", sec.axis = sec_axis(trans = ~./num_doc, name = "Frequency", breaks = seq(0,1, by = 0.1))) + 
#   labs(x = "Column Name", y = "Counts", title = "Counts/Frequency of appearance of most potential party types(51)", subtitle = "across all 3365 deals", caption = "Variables with Counts > 10 are ploted, whereas most of them are 1 which are ignored on this plot") +
#   theme_minimal() +
#   theme(axis.text.x = element_text(angle = 90, face = "bold", size = 16),
#         axis.text.y = element_text(face = "bold", size = 18),
#         axis.text.y.right = element_text(face = "bold", size = 20, color = "red"),
#         plot.title = element_text(hjust = .5, size = 30),
#         axis.title = element_text(size = 25, face = "italic"),
#         axis.title.y.right = element_text(size = 23, face = 4, color = "blue"),
#         plot.subtitle = element_text(hjust = .5, size = 25),
#         plot.caption = element_text(size = 14, colour = "blue"),
#         panel.background = element_rect(fill = "khaki1", color = "white", major.grid),
#         panel.grid = element_line(color = "green3"),
#         panel.grid.minor = element_blank()) 
# ggsave("Counts\\Frequency of appearance of most potential party types(51).png", width = 70, height = 30, units = "cm")
```

Check once party type

```{r}
# for(i in 1:dim(all)[1]){
#   starting <- regexpr("Parties and states of incorporation", all[i,2])
#   rest <- variable[variable != "Parties and states of incorporation"]
#   ending_ma <- rep(0, length(rest))
#   ending_ma <- data.frame(rest, ending_ma)
#   for(j in seq_along(rest)){ ending_ma[j,2] <- regexpr(rest[j], all[i,2], fixed = T) }
#   ending_ma <- ending_ma[ending_ma$ending_ma > starting, ]
#   ending <- ending_ma %>% slice_min(ending_ma) %>% pull(ending_ma)
#   
#   text <- substr(all[i,2], start = starting + 36, stop = ending - 2)
#   if(grepl("Buyer Bank: River Bank & Trust (Alabama), not a party to the merger agreement Target", text, fixed = T)) {print(text)
#     print(strsplit(text, "\n"))
#     print(all[i,1])}
#   
# }
```

# extract values for main types

```{r}
va_no_pa <- variable[-1]
length(va_no_pa)
#which(va_no_pa == "Indemnification: survival period(s)")
```

```{r}
fre <- fre_table_party %>%
  mutate(st := case_when(
    substr(uni_inside, nchar(uni_inside)-2, nchar(uni_inside)) == "ies" ~ gsub("ies", "y", uni_inside, fixed = T),
    substr(uni_inside, nchar(uni_inside), nchar(uni_inside)) == "s" ~ substr(uni_inside, 1, nchar(uni_inside)-1),
    TRUE ~ uni_inside
    )
)
```

```{r}
71 + length(party_col) + length(law_column)
dim(deal)
base::setdiff(colnames(deal), c("Deal name", va_no_pa, party_col, law_column))
party_col[grep("Buyer Sponsor Guarantor", party_col)]
```

```{r}
begin <- Sys.time()

deal <- data.frame(matrix(ncol = 71 + length(party_col) + length(law_column), nrow = nrow(all)))
colnames(deal) <- c("Deal name", va_no_pa, party_col, law_column)

for(i in 1:nrow(all)){
  deal[i, 1] <- all[i,1]
  # insert general column information
  for(q in seq_along(va_no_pa)){
    #i = 1
    #q = 36
    starting <- regexpr(paste0("\n", va_no_pa[q], "\n"), all[i, 2], fixed = TRUE)
    if(starting == -1) {starting <- regexpr(paste0("\n", va_no_pa[q], " "), all[i, 2], fixed = TRUE)}
    if(starting == -1) {starting <- regexpr(paste0(" ", va_no_pa[q], "\n"), all[i, 2], fixed = TRUE)}
    if(starting == -1) {starting <- regexpr(paste0(" ", va_no_pa[q], " "), all[i, 2], fixed = TRUE)}
    if(starting == -1){ deal[i, paste0(va_no_pa[q])] <- NA } else {
    starting <- starting + nchar(va_no_pa[q]) + 2
    rest <- va_no_pa[va_no_pa != va_no_pa[q]]
    remaining <- substr(all[i,2], start = starting, stop = nchar(all[i,2]))
    index <- rep(NA, length(rest))
    for(j in 1:length(rest)){
      # a <- regexpr(paste0("\n", rest[j], "\n"), remaining, fixed = TRUE)
      # d <- regexpr(paste0("\n", rest[j], " "), remaining, fixed = TRUE)
      # b <- regexpr(paste0(" ", rest[j], "\n"), remaining, fixed = TRUE)
      # c <- regexpr(paste0(" ", rest[j], " "), remaining, fixed = TRUE)
      # index[j] <- ifelse(a != -1, a, ifelse(d != -1, d, ifelse(b != -1, b, c)))
      index[j] <- regexpr(paste0("\n", rest[j], "\n"), remaining, fixed = TRUE)
      if(index[j] == -1) {index[j] <- regexpr(paste0("\n", rest[j], " "), remaining, fixed = TRUE)}
      if(index[j] == -1) {index[j] <- regexpr(paste0(" ", rest[j], "\n"), remaining, fixed = TRUE)}
      if(index[j] == -1) {index[j] <- regexpr(paste0(" ", rest[j], " "), remaining, fixed = TRUE)}
    }
    if(all(index < 0))
    {
      deal[i, paste0(va_no_pa[q])] <- substr(all[i,2], start = starting, stop = nchar(all[i,2]))
    } else{
      ending <- min(index[index > 0]) - 2
      deal[i, paste0(va_no_pa[q])] <- substr(all[i,2], start = starting, stop = starting + ending)
    }
    }
  }
  
  # insert lawer info
  for(q in seq_along(law)){
    #i = 2
    #q = 1
    starting <- regexpr(paste0("\n", law[q], "\n"), all[i, 2], fixed = TRUE)
    if(starting == -1) {starting <- regexpr(paste0("\n", law[q], " "), all[i, 2], fixed = TRUE)}
    if(starting == -1) {starting <- regexpr(paste0(" ", law[q], "\n"), all[i, 2], fixed = TRUE)}
    if(starting == -1) {starting <- regexpr(paste0(" ", law[q], " "), all[i, 2], fixed = TRUE)}
    if(starting == -1) { m <- 0 } else {
    starting <- starting + nchar(law[q]) + 2
    rest <- va_no_pa[va_no_pa != law[q]]
    remaining <- substr(all[i,2], start = starting, stop = nchar(all[i,2]))
    index <- rep(NA, length(rest))
    for(j in 1:length(rest)){
      index[j] <- regexpr(paste0("\n", rest[j], "\n"), remaining, fixed = TRUE)
      if(index[j] == -1) {index[j] <- regexpr(paste0("\n", rest[j], " "), remaining, fixed = TRUE)}
      if(index[j] == -1) {index[j] <- regexpr(paste0(" ", rest[j], "\n"), remaining, fixed = TRUE)}
      if(index[j] == -1) {index[j] <- regexpr(paste0(" ", rest[j], " "), remaining, fixed = TRUE)}
    }
    if(all(index < 0))
    {
      text_law <- substr(all[i,2], start = starting, stop = nchar(all[i,2]))
    } else{
      ending <- min(index[index > 0]) - 2
      text_law <- substr(all[i,2], start = starting, stop = starting + ending)
    }
    }
    text_law <- strsplit(text_law, split = "\n")[[1]]
    num_law <- rep(0, length(text_law))
    for(k in seq_along(text_law)){
      #k = 1
      if(grepl("-", text_law[k], fixed = T)){
        firm <- substr(text_law[k], 1, gregexpr(" -", text_law[k], fixed = T)[[1]][1]-1)
        post <- substr(text_law[k], gregexpr("-", text_law[k], fixed = T)[[1]][1] + 2, nchar(text_law))
        #num_law[k] <- length(str_match_all(post, ", ")[[1]]) + length(str_match_all(post, " and ")[[1]]) + 1
        lawer <- strsplit(post, split = ", | and ")[[1]]
        for(h in seq_along(lawer)){
          if(q == 1){
            deal[i, paste0("Buyer:Lawyer ", h+sum(num_law))] <- lawer[h]
            deal[i, paste0("Buyer:Lawyer ", h+sum(num_law), " Law Firm")] <- firm
          }
          if(q == 2){
            deal[i, paste0("Target/Seller:Lawyer ", h+sum(num_law))] <- lawer[h]
            deal[i, paste0("Target/Seller:Lawyer ", h+sum(num_law), " Law Firm")] <- firm
          }
        }
        num_law[k] <- length(strsplit(post, split = ", | and ")[[1]])
      } else {
        firm <- text_law[k]
        if(q == 1){
            deal[i, paste0("Buyer:Lawyer ", 1+sum(num_law))] <- NA
            deal[i, paste0("Buyer:Lawyer ", 1+sum(num_law), " Law Firm")] <- firm
          }
          if(q == 2){
            deal[i, paste0("Target/Seller:Lawyer ", 1+sum(num_law))] <- NA
            deal[i, paste0("Target/Seller:Lawyer ", 1+sum(num_law), " Law Firm")] <- firm
          }
        num_law[k] <- 1
      }
    }
  }
  
  # insert party information
  #i = 4
  starting <- regexpr("Parties and states of incorporation", all[i,2])
  rest <- variable[variable != "Parties and states of incorporation"]
  ending_ma <- rep(0, length(rest))
  ending_ma <- data.frame(rest, ending_ma)
  for(j in seq_along(rest)){ ending_ma[j,2] <- regexpr(rest[j], all[i,2], fixed = T) }
  ending_ma <- ending_ma[ending_ma$ending_ma > starting, ]
  ending <- ending_ma %>% slice_min(ending_ma) %>% pull(ending_ma)
  text <- substr(all[i,2], start = starting + nchar(variable[1]), stop = ending - 2)
  text <- paste0(text, "#")
  
  set <- c()
  for(q in seq(uni_inside)){
    #q = 227
    if(grepl(paste0(" ", uni_inside[q], ":"), text, fixed = T)
       |
       grepl(paste0("\n", uni_inside[q], ":"), text, fixed = T)){ set <- c(set, uni_inside[q]) }}
  # text
  # set
  for(q in seq(uni_inside)){ 
    #q = 5
    if(uni_inside[q] %in% set){
      # res <- str_extract(pattern = paste0(uni_inside[q], ":", "(.+?)(", paste0(set, collapse = ":|"), ":|#)"), string = text)
      # st <- res[2]
      # so <- attr(res, "match.length")[2] + st -1
      # field <- substr(text, st, so)
      starting <- regexpr(paste0(uni_inside[q], ":"), text)
      rest <- set[set != uni_inside[q]]
      ending_ma <- rep(0, length(rest))
      ending_ma <- data.frame(rest, ending_ma)
      for(j in seq_along(rest)){ ending_ma[j,2] <- regexpr(paste0(rest[j], ":"), text, fixed = T) }
      ending_ma <- ending_ma[ending_ma$ending_ma > starting, ]
      ending <- ending_ma %>% slice_min(ending_ma) %>% pull(ending_ma)
      if(length(ending) == 1){
        field <- substr(text, start = starting + nchar(uni_inside[q]) + 1, stop = ending - 1)
      } else {
        field <- substr(text, start = starting + nchar(uni_inside[q]) + 1, nchar(text))
      }
      #field
      num_and <- length(str_match_all(field, " and ")[[1]])
      loc <- str_match_all(field, "\\((.+?)\\)")[[1]]
      num_loc <- length(loc[,2])
      true_and <- num_and - sum(grepl(" and ", loc[,2], fixed = T))
      
      if(true_and == 0){
        f_s <- strsplit(field, split = "\\((.+?)\\)")[[1]]
        if(length(f_s) > 1){
        deal[i, paste0(fre[fre$uni_inside == uni_inside[q],"st"], 1)] <- str_trim(f_s[1], side = "both")
        deal[i, paste0(fre[fre$uni_inside == uni_inside[q],"st"], "1_location")] <- str_match(field, "\\((.+?)\\)")[2]
        if(f_s[2] != "\n"){
          wait <- gsub("^, ", "", str_trim(f_s[2], side = "both"))
          deal[i, paste0(fre[fre$uni_inside == uni_inside[q],"st"], "_note")] <- ifelse(substr(wait, nchar(wait), nchar(wait)) == "#", substr(wait, 1, nchar(wait)-1), wait) 
        }
        } else if(length(f_s) == 1){
          deal[i, paste0(fre[fre$uni_inside == uni_inside[q],"st"], 1)] <- str_trim(f_s[1], side = "both")
        }
        
      } else {
        if(num_loc == 0){
          f_and <- strsplit(field, split = " and ")[[1]]
          for(d in 1:length(f_and)){
            deal[i,paste0(fre[fre$uni_inside == uni_inside[q],"st"],d)] <- str_trim(f_and[d],side="both")
          }
        } else{
        f_s <- strsplit(field, split = "\\)")[[1]]
        if(tail(f_s, n=1) != "#" & tail(f_s, n=1) != "\n"){
            wait <- gsub("^, ", "" , str_trim(tail(f_s, n=1), side = "both"))
            deal[i, paste0(fre[fre$uni_inside == uni_inside[q],"st"], "_note")] <- ifelse(substr(wait, nchar(wait), nchar(wait)) == "#", substr(wait, 1, nchar(wait)-1), wait) 
          }
        for(k in 1:num_loc){
          #k = 1
          f <- strsplit(f_s[k], split = "\\(")[[1]]
          if(length(f) > 1){
          deal[i, paste0(fre[fre$uni_inside == uni_inside[q],"st"], k)] <- gsub("^, |^and ", "" ,str_trim(f[1], side = "both"))
          deal[i, paste0(fre[fre$uni_inside == uni_inside[q],"st"], k, "_location")] <- str_trim(f[2], side = "both")
          
          } else if(length(f) == 1){
            deal[i, paste0(fre[fre$uni_inside == uni_inside[q],"st"], k)] <- str_trim(f[1], side = "both")
          }
        } 
        }
      }
    }
  }
  
}

stop <- Sys.time()
stop - begin
View(deal)
write_csv(x = deal, file = "deal.csv", col_names = T)
write_csv(x = deal[1:10, ], file = "deal_first_10_rows.csv", col_names = T)
write_excel_csv(x = deal, file = "deal(1).csv", col_names = T)
#save.image(file = "deal.RData")
#all[20,1]
#which(uni_inside == "Principal Sellers")
dim(deal)
colnames(deal)[grep("^Buyer:Lawyer 1", colnames(deal))]
```

```{r}
deal[1:10, c("Buyer:Lawyer 1", "Buyer:Lawyer 1 Law Firm")]
grep("^Buyer:Lawyer 1$", colnames(deal))
deal[1:10, 2863]
```

# Extract law firm and lawers

```{r}
law <- variable[grep("Representing law firm", variable)]
```

# Confirm max possible lawer column

```{r}
law_fre <- data.frame(law = law, fre = 0)
for(i in 1:nrow(all)){
  #deal[i, 1] <- all[i,1]
  for(q in seq_along(law)){
    #i = 1
    #q = 2
    starting <- regexpr(paste0("\n", law[q], "\n"), all[i, 2], fixed = TRUE)
    if(starting == -1) {starting <- regexpr(paste0("\n", law[q], " "), all[i, 2], fixed = TRUE)}
    if(starting == -1) {starting <- regexpr(paste0(" ", law[q], "\n"), all[i, 2], fixed = TRUE)}
    if(starting == -1) {starting <- regexpr(paste0(" ", law[q], " "), all[i, 2], fixed = TRUE)}
    if(starting == -1) { m <- 0 } else {
    starting <- starting + nchar(law[q]) + 2
    rest <- va_no_pa[va_no_pa != law[q]]
    remaining <- substr(all[i,2], start = starting, stop = nchar(all[i,2]))
    index <- rep(NA, length(rest))
    for(j in 1:length(rest)){
      index[j] <- regexpr(paste0("\n", rest[j], "\n"), remaining, fixed = TRUE)
      if(index[j] == -1) {index[j] <- regexpr(paste0("\n", rest[j], " "), remaining, fixed = TRUE)}
      if(index[j] == -1) {index[j] <- regexpr(paste0(" ", rest[j], "\n"), remaining, fixed = TRUE)}
      if(index[j] == -1) {index[j] <- regexpr(paste0(" ", rest[j], " "), remaining, fixed = TRUE)}
    }
    if(all(index < 0))
    {
      text_law <- substr(all[i,2], start = starting, stop = nchar(all[i,2]))
    } else{
      ending <- min(index[index > 0]) - 2
      text_law <- substr(all[i,2], start = starting, stop = starting + ending)
    }
    }
    text_law <- strsplit(text_law, split = "\n")[[1]]
    num_law <- rep(0, length(text_law))
    for(k in seq_along(text_law)){
      if(grepl(" - | – ", text_law[k])){
        post <- substr(text_law[k], gregexpr(" - | – ", text_law[k])[[1]][1] + 3, nchar(text_law[k]))
        #num_law[k] <- length(str_match_all(post, ", ")[[1]]) + length(str_match_all(post, " and ")[[1]]) + 1
        lawer <- split_str(post)
        lawer <- merge_sufname(lawer)
        num_law[k] <- length(lawer)
      } else {
        num_law[k] <- 1
      }
    }
    m <- sum(num_law)
    if( m > law_fre[q, 2] ) { law_fre[q, 2] <- m}
  }
}
law_fre
```

# Create law columns

```{r}
law_column <- c()
for(i in 1:law_fre[1,2]){
  law_column <- c(law_column, paste0("Buyer:Lawyer ", i), paste0("Buyer:Lawyer ", i, " Law Firm"))
}
for(i in 1:law_fre[2,2]){
  law_column <- c(law_column, paste0("Target/Seller:Lawyer ", i), paste0("Target/Seller:Lawyer ", i, " Law Firm"))
}
law_column
```

# Extract lawer info

```{r}
lawer_data <- data.frame(matrix(ncol = length(law_column), nrow = nrow(all)))
colnames(lawer_data) <- law_column
for(i in 1:nrow(all)){
  #deal[i, 1] <- all[i,1]
  for(q in seq_along(law)){
    #i = 1
    #q = 2
    starting <- regexpr(paste0("\n", law[q], "\n"), all[i, 2], fixed = TRUE)
    if(starting == -1) {starting <- regexpr(paste0("\n", law[q], " "), all[i, 2], fixed = TRUE)}
    if(starting == -1) {starting <- regexpr(paste0(" ", law[q], "\n"), all[i, 2], fixed = TRUE)}
    if(starting == -1) {starting <- regexpr(paste0(" ", law[q], " "), all[i, 2], fixed = TRUE)}
    if(starting == -1) { m <- 0 } else {
    starting <- starting + nchar(law[q]) + 2
    rest <- va_no_pa[va_no_pa != law[q]]
    remaining <- substr(all[i,2], start = starting, stop = nchar(all[i,2]))
    index <- rep(NA, length(rest))
    for(j in 1:length(rest)){
      index[j] <- regexpr(paste0("\n", rest[j], "\n"), remaining, fixed = TRUE)
      if(index[j] == -1) {index[j] <- regexpr(paste0("\n", rest[j], " "), remaining, fixed = TRUE)}
      if(index[j] == -1) {index[j] <- regexpr(paste0(" ", rest[j], "\n"), remaining, fixed = TRUE)}
      if(index[j] == -1) {index[j] <- regexpr(paste0(" ", rest[j], " "), remaining, fixed = TRUE)}
    }
    if(all(index < 0))
    {
      text_law <- substr(all[i,2], start = starting, stop = nchar(all[i,2]))
    } else{
      ending <- min(index[index > 0]) - 2
      text_law <- substr(all[i,2], start = starting, stop = starting + ending)
    }
    }
    text_law <- strsplit(text_law, split = "\n")[[1]]
    num_law <- rep(0, length(text_law))
    for(k in seq_along(text_law)){
      if(grepl("-", text_law[k], fixed = T)){
        firm <- substr(text_law[k], 1, gregexpr(" -", text_law[k], fixed = T)[[1]][1]-1)
        post <- substr(text_law[k], gregexpr("-", text_law[k], fixed = T)[[1]][1] + 2, nchar(text_law))
        #num_law[k] <- length(str_match_all(post, ", ")[[1]]) + length(str_match_all(post, " and ")[[1]]) + 1
        lawer <- strsplit(post, split = ", | and ")[[1]]
        for(h in seq_along(lawer)){
          if(q == 1){
            lawer_data[i, paste0("Buyer:Lawyer ", h+sum(num_law))] <- lawer[h]
            lawer_data[i, paste0("Buyer:Lawyer ", h+sum(num_law), " Law Firm")] <- firm
          }
          if(q == 2){
            lawer_data[i, paste0("Target/Seller:Lawyer ", h+sum(num_law))] <- lawer[h]
            lawer_data[i, paste0("Target/Seller:Lawyer ", h+sum(num_law), " Law Firm")] <- firm
          }
        }
        num_law[k] <- length(strsplit(post, split = ", | and ")[[1]])
      } else {
        firm <- substr(text_law[k], 1, gregexpr(" -", text_law[k], fixed = T)[[1]][1]-1)
        if(q == 1){
            lawer_data[i, paste0("Buyer:Lawyer ", 1+sum(num_law))] <- NA
            lawer_data[i, paste0("Buyer:Lawyer ", 1+sum(num_law), " Law Firm")] <- firm
          }
          if(q == 2){
            lawer_data[i, paste0("Target/Seller:Lawyer ", 1+sum(num_law))] <- NA
            lawer_data[i, paste0("Target/Seller:Lawyer ", 1+sum(num_law), " Law Firm")] <- firm
          }
        num_law[k] <- 1
      }
    }
    #m <- sum(num_law)
    #if( m > law_fre[q, 2] ) { law_fre[q, 2] <- m}
  }
}
View(lawer_data)
#strsplit(x = "David Westenberg, John Burgess and Jeff Stein", split = ", | and ")
```

# Test only lawyer and firm columns

## Helper function to detect Jr., III, Sr.

```{r}
merge_sufname <- function(x){
  xnew <- c()
  for(i in seq_along(x)){
    if(x[i+1] %in% c("Jr.", "Sr.", "III", "II", "P.C.", "IV")){
      xnew <- c(xnew, paste0(x[i], " ", x[i+1]))
    }else if(x[i] %in% c("Jr.", "Sr.", "III", "II", "P.C.", "IV")){
      next
    }
    else{
      xnew <- c(xnew, x[i])
    }
  }
  xnew
}

merge_sufname(c("yuan", "li", "Jr.", "ew", "III"))
```

## Helper function to split lawyer name by skipping parenthesis.

```{r}
split_str <- function(x){
  #x = "James M. Rockett (representing Target and Trustee)"
  ori <- str_match_all(x, "\\(.*?\\)")[[1]]
  xnew <- gsub("\\(.*?\\)", "()", x)
  y <- strsplit(xnew, split = ", | or | & | and ")[[1]]
  j = 1
  for(i in seq_along(y)){
    if(grepl("\\(\\)", y[i])){
      y[i] <- gsub("\\(\\)", ori[j], y[i])
      j = j + 1
    }
  }
  y
}
split_str("fndsk & ndsa(dnsj&fn, dwn) or ngjkf (yuan and li) fnes and fe, scs (dw, dwmi) or ncsu(ndw and neu)")
```

```{r}
all <- readtext(file = "/Users/liyuan/Dropbox/George\ RA\ Li\ Yuan\ work/all_docx/all_docx")
lawer_data <- data.frame(matrix(ncol = length(law_column)+1, nrow = nrow(all)))
colnames(lawer_data) <- c("deal", law_column)
for(i in 1:nrow(all)){
# insert lawer info
  lawer_data[i, "deal"] <- all[i, 1]
  for(q in seq_along(law)){
    #i = 1515
    #q = 2
    starting <- regexpr(paste0("\n", law[q], "\n"), all[i, 2], fixed = TRUE)
    if(starting == -1) {starting <- regexpr(paste0("\n", law[q], " "), all[i, 2], fixed = TRUE)}
    if(starting == -1) {starting <- regexpr(paste0(" ", law[q], "\n"), all[i, 2], fixed = TRUE)}
    if(starting == -1) {starting <- regexpr(paste0(" ", law[q], " "), all[i, 2], fixed = TRUE)}
    if(starting == -1) { m <- 0 } else {
    starting <- starting + nchar(law[q]) + 2
    rest <- va_no_pa[va_no_pa != law[q]]
    remaining <- substr(all[i,2], start = starting, stop = nchar(all[i,2]))
    index <- rep(NA, length(rest))
    for(j in 1:length(rest)){
      index[j] <- regexpr(paste0("\n", rest[j], "\n"), remaining, fixed = TRUE)
      if(index[j] == -1) {index[j] <- regexpr(paste0("\n", rest[j], " "), remaining, fixed = TRUE)}
      if(index[j] == -1) {index[j] <- regexpr(paste0(" ", rest[j], "\n"), remaining, fixed = TRUE)}
      if(index[j] == -1) {index[j] <- regexpr(paste0(" ", rest[j], " "), remaining, fixed = TRUE)}
    }
    if(all(index < 0))
    {
      text_law <- substr(all[i,2], start = starting, stop = nchar(all[i,2]))
    } else{
      ending <- min(index[index > 0]) - 2
      text_law <- substr(all[i,2], start = starting, stop = starting + ending)
    }
    }
    text_law <- strsplit(text_law, split = "\n")[[1]]
    num_law <- rep(0, length(text_law))
    for(k in seq_along(text_law)){
      #k = 2
      if(grepl(" - | – ", text_law[k])){
        firm <- substr(text_law[k], 1, gregexpr(" - | – ", text_law[k])[[1]][1]-1)
        post <- substr(text_law[k], gregexpr(" - | – ", text_law[k])[[1]][1] + 3, nchar(text_law[k]))
        #num_law[k] <- length(str_match_all(post, ", ")[[1]]) + length(str_match_all(post, " and ")[[1]]) + 1
        #lawer <- strsplit(post, split = ", | and | or | & ")[[1]]
        lawer <- split_str(post)
        lawer <- merge_sufname(lawer)
        for(h in seq_along(lawer)){
          if(q == 1){
            lawer_data[i, paste0("Buyer:Lawyer ", h+sum(num_law))] <- lawer[h]
            lawer_data[i, paste0("Buyer:Lawyer ", h+sum(num_law), " Law Firm")] <- firm
          }
          if(q == 2){
            lawer_data[i, paste0("Target/Seller:Lawyer ", h+sum(num_law))] <- lawer[h]
            lawer_data[i, paste0("Target/Seller:Lawyer ", h+sum(num_law), " Law Firm")] <- firm
          }
        }
        #num_law[k] <- length(strsplit(post, split = ", | and ")[[1]])
        num_law[k] <- length(lawer)
      } else {
        firm <- text_law[k]
        if(q == 1){
            lawer_data[i, paste0("Buyer:Lawyer ", 1+sum(num_law))] <- NA
            lawer_data[i, paste0("Buyer:Lawyer ", 1+sum(num_law), " Law Firm")] <- firm
          }
          if(q == 2){
            lawer_data[i, paste0("Target/Seller:Lawyer ", 1+sum(num_law))] <- NA
            lawer_data[i, paste0("Target/Seller:Lawyer ", 1+sum(num_law), " Law Firm")] <- firm
          }
        num_law[k] <- 1
      }
    }
  }
}
View(lawer_data)
```



```{r}
write_excel_csv(x = lawer_data, file = "lawyer.csv", col_names = T)
```

## Transpose lawyer data into one deal one law firm

```{r}
deal_lawyer <- data.frame(matrix(ncol = length(law_column)+1, nrow = 0))
colnames(deal_lawyer) <- c("deal", law_column)
for(i in 1:dim(lawer_data)[1]){
  num <- sum(!(lawer_data[i, ] %>% select(ends_with("Law Firm")) %>% as.character() %>% is.na()))
  subset_lawyer <- data.frame(matrix(ncol = length(law_column)+1, nrow = num))
  colnames(subset_lawyer) <- c("deal", law_column)
  subset_lawyer[, "deal"] <- lawer_data[i, "deal"]
  law_firm <- lawer_data[i, 2:33]
  law_firm <- law_firm[, colSums(is.na(law_firm)) == 0]
  firm <- law_firm %>% select(ends_with("Law Firm")) %>% colnames()
  for(j in seq_along(firm)){
    subset_lawyer[j, firm[j]] <- law_firm[1, firm[j]]
    lawyer <- substr(firm[j], 1, nchar(firm[j]) - 9)
    subset_lawyer[j, lawyer] <- ifelse(lawyer %in% colnames(law_firm), law_firm[1, lawyer], NA)
  }
  deal_lawyer <- rbind(deal_lawyer, subset_lawyer)
}
View(deal_lawyer)
write_excel_csv(x = deal_lawyer, file = "deal_lawyer.csv", col_names = T)
```

## Read in deal_lawyer.csv file

```{r}
# library(readr)
deal_lawyer <- read_csv("deal_lawyer.csv",
    col_types = cols(`Buyer:Lawyer 5` = col_character(),
        `Buyer:Lawyer 5 Law Firm` = col_character(),
        `Buyer:Lawyer 6` = col_character(),
        `Buyer:Lawyer 6 Law Firm` = col_character(),
        `Buyer:Lawyer 7` = col_character(),
        `Buyer:Lawyer 7 Law Firm` = col_character(),
        `Buyer:Lawyer 8` = col_character(),
        `Buyer:Lawyer 8 Law Firm` = col_character(),
        `Target/Seller:Lawyer 4` = col_character(),
        `Target/Seller:Lawyer 5` = col_character(),
        `Target/Seller:Lawyer 5 Law Firm` = col_character(),
        `Target/Seller:Lawyer 6` = col_character(),
        `Target/Seller:Lawyer 6 Law Firm` = col_character(),
        `Target/Seller:Lawyer 7` = col_character(),
        `Target/Seller:Lawyer 7 Law Firm` = col_character(),
        `Target/Seller:Lawyer 8` = col_character(),
        `Target/Seller:Lawyer 8 Law Firm` = col_character()))
View(deal_lawyer)

# deal_lawyer <- read.csv("~/Documents/law_database/natural_language_process/codes/deal_lawyer.csv", header = T)
# class(deal_lawyer)
# View(deal_lawyer)
```

## a subset of observations from the Deal-Lawyer database
## If the law firm name is provided but the lawyer name is not

```{r}
only_lawfirm <- data.frame(matrix(ncol = 3, nrow = nrow(deal_lawyer)))
colnames(only_lawfirm) <- c("deal_name", "lawyer", "law_firm")
for(i in 1:nrow(deal_lawyer)){
  lawyer_and_firm <- as.character(deal_lawyer[i, ] %>% select(-deal))
  if(sum(!is.na(lawyer_and_firm)) == 1){
    only_lawfirm[i, "deal_name"] = deal_lawyer[i, "deal"]
    only_lawfirm[i, "law_firm"] = lawyer_and_firm[!is.na(lawyer_and_firm)]
  }
}

only_lawfirm <- only_lawfirm %>% filter(!is.na(deal_name))
View(only_lawfirm)
```


```{r, message=F}
deal <- read_csv(file = "deal(1).csv") %>% select(`Deal name`, `Signing date`, `Closing date`)
View(deal)
```

```{r}
only_lawfirm <- only_lawfirm %>%
  left_join(deal, by = c("deal_name" = "Deal name"))
View(only_lawfirm)

write_csv(x = only_lawfirm, file = "subset_no_lawyer.csv")
```

## Merge deal_lawyer.csv with M&A lawyers database 2020

```{r}
lawyer_2020 <- read_excel("lawyer_2020.xlsx", 
    col_types = c("text", "text", "text", 
        "text", "text", "text", "text", "text", 
        "text", "text", "text", "text", "text", 
        "text", "text", "text", "text", "text", 
        "text", "text", "text", "text", "text", 
        "text", "text", "text", "text", "text", 
        "text", "text"))
View(lawyer_2020)
```

## Split lawyer name columns into first, last and middle

```{r}
# colna <- colnames(deal_lawyer)
# cp_colna <- colna
# for(i in 1:length(colna)){
#   if(grepl(":Lawyer \\d$", colna[i])){
#     new <- c(paste0(colna[i], " Last"), paste0(colna[i], " First"), paste0(colna[i], " MI"))
#     ind <- match(colna[i], cp_colna)
#     cp_colna <- c(cp_colna[1:(ind-1)], new, cp_colna[(ind+1):length(cp_colna)])
#   }
# }
# new_deal_lawyer <- data.frame(matrix(ncol = length(cp_colna), nrow = nrow(deal_lawyer)))
# colnames(new_deal_lawyer) <- cp_colna
# new_deal_lawyer
```

```{r}
# i = 1
# j = 1
# for(i in 1:nrow(deal_lawyer)){
#   new_deal_lawyer[i, "deal"] <- deal_lawyer[i, "deal"]
#   row <- deal_lawyer[i, 2:ncol(deal_lawyer)]
#   for(j in 1:ncol(row)){
#     if(grepl("Firm$", colnames(row)[j]) & !is.na(row[1, colnames(row)[j]])){
#       new_deal_lawyer[i, colnames(row)[j]] <- deal_lawyer[i, colnames(row)[j]]
#     }else if(grepl("Lawyer \\d$", colnames(row)[j]) & !is.na(row[1, colnames(row)[j]])){
#       sp <- strsplit(row[1, colnames(row)[j]], split = " ")[[1]]
#       if(length(sp) == 3){
#         new_deal_lawyer[i, paste0(colnames(row)[j], " First")] <- sp[1]
#         new_deal_lawyer[i, paste0(colnames(row)[j], " MI")] <- sp[2]
#         new_deal_lawyer[i, paste0(colnames(row)[j], " Last")] <- sp[3]
#       }else if(length(sp) == 2){
#         new_deal_lawyer[i, paste0(colnames(row)[j], " First")] <- sp[1]
#         new_deal_lawyer[i, paste0(colnames(row)[j], " Last")] <- sp[2]
#       }else if(length(sp) == 1){
#         new_deal_lawyer[i, paste0(colnames(row)[j], " First")] <- sp[1]
#       }
#     }
#   }
# }
# View(new_deal_lawyer)
```


```{r}
merge_deal_lawyer <- data.frame(matrix(ncol = 6, nrow = nrow(deal_lawyer)))
colnames(merge_deal_lawyer) <- c("deal", "First", "MI", "Last", "Law_Firm", "Type")

for(i in 1:nrow(deal_lawyer)){
  merge_deal_lawyer[i, "deal"] <- deal_lawyer[i, "deal"]
  row <- deal_lawyer[i, 2:ncol(deal_lawyer)]
  for(j in 1:ncol(row)){
    pcol <- colnames(row)[j]
    
    if(grepl("Firm$", pcol) & !is.na(row[1, ] %>% pull(pcol))){
      merge_deal_lawyer[i, "Law_Firm"] <- deal_lawyer[i, pcol]
      merge_deal_lawyer[i, "Type"] <- ifelse(grepl("Buyer", pcol), "Buyer", "Target/Seller")
    }else if(grepl("Lawyer \\d$", pcol) & !is.na(row[1, ] %>% pull(pcol))){
      sp <- strsplit(row[1, ] %>% pull(pcol), split = " ")[[1]]
      if(length(sp) == 3){
        merge_deal_lawyer[i, "First"] <- sp[1]
        merge_deal_lawyer[i, "MI"] <- sp[2]
        merge_deal_lawyer[i, "Last"] <- sp[3]
      }else if(length(sp) == 2){
        merge_deal_lawyer[i, "First"] <- sp[1]
        merge_deal_lawyer[i, "Last"] <- sp[2]
      }else if(length(sp) == 1){
        merge_deal_lawyer[i, "First"] <- sp[1]
      }
    }
  }
}
View(merge_deal_lawyer)

write_csv(x = merge_deal_lawyer, file = "merge_deal_lawyer.csv")
```

```{r}
# deal_lawyer_full <- merge_deal_lawyer %>%
#   mutate(First = tolower(First), Last = tolower(Last), Law_Firm = tolower(Law_Firm)) %>%
#   left_join(lawyer_2020 %>% mutate(Firm = tolower(Firm), First = tolower(First), Last = tolower(Last)), by = c("Law_Firm" = "Firm", "First" = "First", "Last" = "Last")) %>% 
#   mutate(First = str_to_title(First), Last = str_to_title(Last), Law_Firm = str_to_title(Law_Firm))
```

```{r}
# deal_lawyer_full <- deal_lawyer_full %>%
#   left_join(deal, by = c("deal" = "Deal name")) %>%
#   select(deal, `Signing date`, `Closing date`, everything())
# 
# View(deal_lawyer_full)
# 
# write_csv(x = deal_lawyer_full, file = "deal_lawyer_full.csv")
```

```{r}
# deal_lawyer_full_fl <- merge_deal_lawyer %>%
#   mutate(First = tolower(First), Last = tolower(Last)) %>%
#   left_join(lawyer_2020 %>% mutate(First = tolower(First), Last = tolower(Last)), by = c("First" = "First", "Last" = "Last")) %>% 
#   mutate(First = str_to_title(First), Last = str_to_title(Last)) 
# View(deal_lawyer_full_fl)
```

```{r}
# deal_lawyer_full_fi_la <- merge_deal_lawyer %>%
#   mutate(Last = tolower(Last), Law_Firm = tolower(Law_Firm)) %>%
#   left_join(lawyer_2020 %>% mutate(Firm = tolower(Firm), Last = tolower(Last)), by = c("Law_Firm" = "Firm", "First" = "First", "Last" = "Last")) %>% 
#   mutate( Last = str_to_title(Last), Law_Firm = str_to_title(Law_Firm))
# View(deal_lawyer_full_fi_la)
```

# Fix the lawyer_2020.csv

```{r}
colna <- colnames(lawyer_2020)
lawyer_2020_1 <- lawyer_2020
lawyer_2020_1[26001:26082, colna[5:29]] <- lawyer_2020[26001:26082, colna[6:30]]
lawyer_2020_1[26001:26082, colna[30]] <- lawyer_2020[26001:26082, 5]
# View(lawyer_2020_1)

lawyer_2020_2 <- lawyer_2020_1
lawyer_2020_2[24001:26082, colna[28:29]] <- lawyer_2020_1[24001:26082, colna[27:28]]
lawyer_2020_2[24001:26082, colna[27]] <- lawyer_2020_1[24001:26082, colna[30]]
lawyer_2020_2[24001:26082, colna[30]] <- NA
# View(lawyer_2020_2)

lawyer_2020_3 <- lawyer_2020_2
lawyer_2020_3[20001:22000, colna[28:29]] <- lawyer_2020_2[20001:22000, colna[27:28]]
lawyer_2020_3[20001:22000, colna[27]] <- lawyer_2020_2[20001:22000, colna[29]]
# View(lawyer_2020_3)

lawyer_2020_4 <- lawyer_2020_3
lawyer_2020_4[14001:18000, colna[28:29]] <- lawyer_2020_3[14001:18000, colna[27:28]]
lawyer_2020_4[14001:18000, colna[27]] <- lawyer_2020_3[14001:18000, colna[30]]
lawyer_2020_4[14001:18000, colna[30]] <- NA
# View(lawyer_2020_4)

lawyer_2020_5 <- lawyer_2020_4
lawyer_2020_5[10001:12000, colna[28:29]] <- lawyer_2020_4[10001:12000, colna[27:28]]
lawyer_2020_5[10001:12000, colna[27]] <- lawyer_2020_4[10001:12000, colna[29]]
# View(lawyer_2020_5)

lawyer_2020_6 <- lawyer_2020_5
lawyer_2020_6[6001:8000, colna[28:29]] <- lawyer_2020_5[6001:8000, colna[27:28]]
lawyer_2020_6[6001:8000, colna[27]] <- lawyer_2020_5[6001:8000, colna[30]]
lawyer_2020_6[6001:8000, colna[30]] <- NA
View(lawyer_2020_6)
```

# The final fixed lawyer 2020 data set

```{r}
write_csv(x = lawyer_2020_6, file = "lawyer_2020_M&A_fixed.csv")
```

# Join lawyer_2020_6 with merge_deal_lawyer

## First confidence

```{r}
deal_lawyer_full <- merge_deal_lawyer %>%
  mutate(First = tolower(First), Last = tolower(Last), Firm = tolower(Law_Firm)) %>%
  inner_join(lawyer_2020_6 %>% mutate(Firm = tolower(Firm), First = tolower(First), 
                                     Last = tolower(Last)), 
            by = c("Firm" = "Firm", "First" = "First", "Last" = "Last")) %>% 
  mutate(First = str_to_title(First), Last = str_to_title(Last)) %>%
  select(-Firm)


deal_lawyer_full <- deal_lawyer_full %>%
  left_join(deal, by = c("deal" = "Deal name")) %>%
  select(deal, `Signing date`, `Closing date`, everything())

View(deal_lawyer_full)

write_csv(x = deal_lawyer_full, file = "deal_lawyer_full.csv")
```

### Anti-join to get rows which are not matched with any rows in y

```{r}
deal_lawyer_full_no_match <- merge_deal_lawyer %>%
  mutate(First = tolower(First), Last = tolower(Last), Firm = tolower(Law_Firm)) %>%
  anti_join(lawyer_2020_6 %>% mutate(Firm = tolower(Firm), First = tolower(First), 
                                     Last = tolower(Last)), 
            by = c("Firm" = "Firm", "First" = "First", "Last" = "Last")) %>% 
  mutate(First = str_to_title(First), Last = str_to_title(Last)) %>%
  select(-Firm)


deal_lawyer_full_no_match <- deal_lawyer_full_no_match %>%
  left_join(deal, by = c("deal" = "Deal name")) %>%
  select(deal, `Signing date`, `Closing date`, everything())

View(deal_lawyer_full_no_match)

write_csv(x = deal_lawyer_full_no_match, file = "deal_lawyer_full_no_match.csv")
```

## Second confidence on no match data using first and last name

```{r}
deal_lawyer_first_last <- deal_lawyer_full_no_match %>%
  mutate(First = tolower(First), Last = tolower(Last)) %>%
  inner_join(lawyer_2020_6 %>% mutate(First = tolower(First), 
                                     Last = tolower(Last)), 
            by = c("First" = "First", "Last" = "Last")) %>% 
  mutate(First = str_to_title(First), Last = str_to_title(Last))


View(deal_lawyer_first_last)

write_csv(x = deal_lawyer_first_last, file = "deal_lawyer_first_last.csv")
```

## Anti-join to get no match

```{r}
deal_lawyer_first_last_no_match <- deal_lawyer_full_no_match %>%
  mutate(First = tolower(First), Last = tolower(Last)) %>%
  anti_join(lawyer_2020_6 %>% mutate(First = tolower(First), 
                                     Last = tolower(Last)), 
            by = c("First" = "First", "Last" = "Last")) %>% 
  mutate(First = str_to_title(First), Last = str_to_title(Last))


View(deal_lawyer_first_last_no_match)

write_csv(x = deal_lawyer_first_last_no_match, file = "deal_lawyer_first_last_no_match.csv")
```

# The thrid confidence

```{r}
deal_lawyer_firm_last <- deal_lawyer_first_last_no_match %>%
  mutate(Firm = tolower(Law_Firm), Last = tolower(Last)) %>%
  inner_join(lawyer_2020_6 %>% mutate(Firm = tolower(Firm), 
                                     Last = tolower(Last)), 
            by = c("Firm" = "Firm", "Last" = "Last")) %>% 
  mutate(Last = str_to_title(Last)) %>%
  select(-Firm)

View(deal_lawyer_firm_last)

write_csv(x = deal_lawyer_firm_last, file = "deal_lawyer_firm_last.csv")
```

## Anti-join to get remaining unmatched rows

```{r}
deal_lawyer_firm_last_no_match <- deal_lawyer_first_last_no_match %>%
  mutate(Firm = tolower(Law_Firm), Last = tolower(Last)) %>%
  anti_join(lawyer_2020_6 %>% mutate(Firm = tolower(Firm), 
                                     Last = tolower(Last)), 
            by = c("Firm" = "Firm", "Last" = "Last")) %>% 
  mutate(Last = str_to_title(Last)) %>%
  select(-Firm)

View(deal_lawyer_firm_last_no_match)

write_csv(x = deal_lawyer_firm_last_no_match, file = "deal_lawyer_firm_last_no_match.csv")
```


# Read in Corporate lawyer database

```{r}
Cor_lawyer_2020 <- read_excel("Cor_lawyer_2020.xlsx", 
    col_types = c("text", "text", "text", 
        "text", "text", "text", "text", "text", 
        "text", "text", "text", "text", "text", 
        "text", "text", "text", "text", "text", 
        "text", "text", "text", "text", "text", 
        "text", "text", "text", "text", "text", 
        "text", "text"))
View(Cor_lawyer_2020)
class(Cor_lawyer_2020)
```

# Shift two columns

```{r, warning=F}
Cor_lawyer_2020_1 <- Cor_lawyer_2020
for(i in 1:nrow(Cor_lawyer_2020_1)){
  flag = 0
  promove <- Cor_lawyer_2020_1[i, ] %>% pull(`Firm Title`)
  if(!is.na(promove) & !is.na(as.numeric(promove)) & is.na(Cor_lawyer_2020_1[i, "ProbabilityOfMove"])){
    Cor_lawyer_2020_1[i, "ProbabilityOfMove"] <- promove
    Cor_lawyer_2020_1[i, "Firm Title"] <- NA
    flag = 1
  }
  
  if(flag | (!flag & is.na(promove))){
    ftitle <- Cor_lawyer_2020_1[i, ] %>% pull(Gender)
    if(!ftitle %in% c("male", "Male", "female", "Female") & !is.na(ftitle)){
      Cor_lawyer_2020_1[i, "Firm Title"] <- ftitle
      Cor_lawyer_2020_1[i, "Gender"] <- NA
    }
  }
}
View(Cor_lawyer_2020_1)

write_csv(x = Cor_lawyer_2020_1, file = "Cor_lawyer_2020_fixed.csv")
```

# merge using Cor_lawyer_2020_1

## First confidence

```{r}
deal_lawyer_full <- merge_deal_lawyer %>%
  mutate(First = tolower(gsub("\\.$", "", First)), 
         Last = tolower(gsub("\\.$", "", Last)), 
         Firm = tolower(gsub("\\.$", "", Law_Firm))) %>%
  inner_join(Cor_lawyer_2020_1 %>% mutate(Firm = tolower(gsub("\\.$", "", Firm)), 
                                          First = tolower(gsub("\\.$", "", First)), 
                                          Last = tolower(gsub("\\.$", "", Last))), 
            by = c("Firm" = "Firm", "First" = "First", "Last" = "Last")) %>% 
  mutate(First = str_to_title(First), Last = str_to_title(Last)) %>%
  select(-Firm)


deal_lawyer_full <- deal_lawyer_full %>%
  left_join(deal, by = c("deal" = "Deal name")) %>%
  select(deal, `Signing date`, `Closing date`, everything())

View(deal_lawyer_full)

write_csv(x = deal_lawyer_full, file = "Cor_deal_lawyer_full.csv")
```

### Anti-join to get rows which are not matched with any rows in y

```{r}
deal_lawyer_full_no_match <- merge_deal_lawyer %>%
  mutate(First = tolower(gsub("\\.$", "", First)), 
         Last = tolower(gsub("\\.$", "", Last)), 
         Firm = tolower(gsub("\\.$", "", Law_Firm))) %>%
  anti_join(Cor_lawyer_2020_1 %>% mutate(Firm = tolower(gsub("\\.$", "", Firm)), 
                                         First = tolower(gsub("\\.$", "", First)), 
                                         Last = tolower(gsub("\\.$", "", Last))), 
            by = c("Firm" = "Firm", "First" = "First", "Last" = "Last")) %>% 
  mutate(First = str_to_title(First), Last = str_to_title(Last)) %>%
  select(-Firm)


deal_lawyer_full_no_match <- deal_lawyer_full_no_match %>%
  left_join(deal, by = c("deal" = "Deal name")) %>%
  select(deal, `Signing date`, `Closing date`, everything())

View(deal_lawyer_full_no_match)

write_csv(x = deal_lawyer_full_no_match, file = "Cor_deal_lawyer_full_no_match.csv")
```

## Second confidence on no match data using first and last name

```{r}
deal_lawyer_first_last <- deal_lawyer_full_no_match %>%
  mutate(First = tolower(gsub("\\.$", "", First)), 
         Last = tolower(gsub("\\.$", "", Last))) %>%
  inner_join(Cor_lawyer_2020_1 %>% mutate(First = tolower(gsub("\\.$", "", First)), 
                                          Last = tolower(gsub("\\.$", "", Last))), 
            by = c("First" = "First", "Last" = "Last")) %>% 
  mutate(First = str_to_title(First), Last = str_to_title(Last))


View(deal_lawyer_first_last)

write_csv(x = deal_lawyer_first_last, file = "Cor_deal_lawyer_first_last.csv")
```

## Anti-join to get no match

```{r}
deal_lawyer_first_last_no_match <- deal_lawyer_full_no_match %>%
  mutate(First = tolower(gsub("\\.$", "", First)), 
         Last = tolower(gsub("\\.$", "", Last))) %>%
  anti_join(Cor_lawyer_2020_1 %>% mutate(First = tolower(gsub("\\.$", "", First)), 
                                         Last = tolower(gsub("\\.$", "", Last))), 
            by = c("First" = "First", "Last" = "Last")) %>% 
  mutate(First = str_to_title(First), Last = str_to_title(Last))


View(deal_lawyer_first_last_no_match)

write_csv(x = deal_lawyer_first_last_no_match, file = "Cor_deal_lawyer_first_last_no_match.csv")
```

# The thrid confidence

```{r}
deal_lawyer_firm_last <- deal_lawyer_first_last_no_match %>%
  mutate(Firm = tolower(gsub("\\.$", "", Law_Firm)), 
         Last = tolower(gsub("\\.$", "", Last))) %>%
  inner_join(Cor_lawyer_2020_1 %>% mutate(Firm = tolower(gsub("\\.$", "", Firm)), 
                                          Last = tolower(gsub("\\.$", "", Last))), 
            by = c("Firm" = "Firm", "Last" = "Last")) %>% 
  mutate(Last = str_to_title(Last)) %>%
  select(-Firm)

View(deal_lawyer_firm_last)

write_csv(x = deal_lawyer_firm_last, file = "Cor_deal_lawyer_firm_last.csv")
```

## Anti-join to get remaining unmatched rows

```{r}
deal_lawyer_firm_last_no_match <- deal_lawyer_first_last_no_match %>%
  mutate(Firm = tolower(gsub("\\.$", "", Law_Firm)), 
         Last = tolower(gsub("\\.$", "", Last))) %>%
  anti_join(Cor_lawyer_2020_1 %>% mutate(Firm = tolower(gsub("\\.$", "", Firm)), 
                                         Last = tolower(gsub("\\.$", "", Last))), 
            by = c("Firm" = "Firm", "Last" = "Last")) %>% 
  mutate(Last = str_to_title(Last)) %>%
  select(-Firm)

View(deal_lawyer_firm_last_no_match)

write_csv(x = deal_lawyer_firm_last_no_match, file = "Cor_deal_lawyer_firm_last_no_match.csv")
```


# Combine two data set, one is Cor_lawyer_2020_1 and another is lawyer_2020_6

```{r}
# To test if two sets of column names are identical or not
col_cor <- colnames(Cor_lawyer_2020_1)
col_ma <- colnames(lawyer_2020_6)

identical(col_cor, col_ma)
```

# Add an indicator column 

```{r}
lawyer_2020_6 <- lawyer_2020_6 %>%
  mutate(Source := "M&A") %>%
  select(FirmId, Firm, Last, First, MI, Source, everything())
```

```{r}
Cor_lawyer_2020_1 <- Cor_lawyer_2020_1 %>%
  mutate(Source := "Corporate") %>%
  select(FirmId, Firm, Last, First, MI, Source, everything())
```

# Combine two data set

```{r}
# row bind two data sets
com_Cor_MA <- rbind(lawyer_2020_6, Cor_lawyer_2020_1)
View(com_Cor_MA)
```

```{r}
# Test if there are missing rows during merging
nrow(com_Cor_MA) == nrow(lawyer_2020_6) + nrow(Cor_lawyer_2020_1)
```

# Find duplicates

```{r}
# Find common lawyer info
common_lawyer <- com_Cor_MA %>%
  count(Firm, FirmId, Last, First, Email, `JD Year`, `Law School`, Undergrad, Gender, Race) %>%
  filter(n > 1) %>%
  arrange(desc(n))

View(common_lawyer)
```

# Delete duplicates

```{r}
dis_col <- colnames(com_Cor_MA)[-6]
paste0(dis_col, collapse = ", ")
```

```{r}
distin_com_lawyer <- com_Cor_MA %>%
  distinct(FirmId, Firm, Last, First, MI, Email, Phone, `JD Year`, `Law School`, `Practice Area`, Specialties, `Honors / Degrees`, Languages, Undergrad, Admitted, Loc, Link, LinkedIn, Status, Updated, `Type / Secondary_Type`, Memberships, Corporations, `Education Info`, `Origin Firm`, Gender, Race, `Firm Title`, ProbabilityOfMove, Notes, .keep_all = T)

# View(distin_com_lawyer)

nrow(com_Cor_MA) - nrow(distin_com_lawyer)

distin_com_lawyer <- com_Cor_MA %>%
  distinct(.keep_all = T)

# View(distin_com_lawyer)

nrow(com_Cor_MA) - nrow(distin_com_lawyer)
```


```{r}
distin_com_lawyer <- com_Cor_MA %>%
  distinct(FirmId, Firm, Last, First, MI, `JD Year`, `Law School`, 
           Undergrad, Admitted, Gender, Race, Email, .keep_all = T)

 View(distin_com_lawyer)

nrow(com_Cor_MA) - nrow(distin_com_lawyer)

# sum(common_lawyer$n) - nrow(common_lawyer)

write_csv(x = distin_com_lawyer, file = "distinct_binded_lawyer_2020.csv")
```



# Read in "distinct_binded_lawyer_2020.csv"

```{r}
distin_com_lawyer <- read_csv("distinct_binded_lawyer_2020.csv", 
    col_types = cols(FirmId = col_character(), 
        `JD Year` = col_character(), ProbabilityOfMove = col_character(), 
        Notes = col_character()))
View(distin_com_lawyer)
```

# Merge merge_deal_lawyer with new_pri to find our more missing lawyer info

```{r}
merge_deal_lawyer <- read_csv("merge_deal_lawyer.csv")
View(merge_deal_lawyer)
```

# Add new RA missing lawyer database

```{r}
private_aci_new <- read_csv("private_aci_new.csv")
View(private_aci_new)
```

# Combine RA found missing lawyer with original deal_lawyer database

```{r}
new_private <- new_pri %>% 
  select(-`Signing date`, -`Closing date`) %>%
  rename(MI = MI.x, Law_Firm = `Law Firm 1`)

merge_deal_lawyer <- rbind(merge_deal_lawyer, new_private)
View(merge_deal_lawyer)
```

```{r}
#merge_deal_lawyer %>%
#merge_deal_lawyer[duplicated(merge_deal_lawyer[, c(1,5,6)]), ] %>% View
```

```{r}
deal <- read_csv("deal(1).csv") %>% select(`Deal name`, `Signing date`, `Closing date`)
View(deal)
```

# merge using distin_com_lawyer

## First confidence

```{r}
deal_lawyer_full <- merge_deal_lawyer %>%
  mutate(First = tolower(gsub("\\.$", "", First)), 
         Last = tolower(gsub("\\.$", "", Last)), 
         Firm = tolower(gsub("\\.$", "", Law_Firm))) %>%
  inner_join(distin_com_lawyer %>% mutate(Firm = tolower(gsub("\\.$", "", Firm)), 
                                          First = tolower(gsub("\\.$", "", First)), 
                                          Last = tolower(gsub("\\.$", "", Last))), 
            by = c("Firm" = "Firm", "First" = "First", "Last" = "Last")) %>% 
  mutate(First = str_to_title(First), Last = str_to_title(Last)) %>%
  select(-Firm)


deal_lawyer_full <- deal_lawyer_full %>%
  left_join(deal, by = c("deal" = "Deal name")) %>%
  select(deal, `Signing date`, `Closing date`, everything())

View(deal_lawyer_full)

write_csv(x = deal_lawyer_full, file = "com_deal_lawyer_full.csv")
```

### Anti-join to get rows which are not matched with any rows in y

```{r}
deal_lawyer_full_no_match <- merge_deal_lawyer %>%
  mutate(First = tolower(gsub("\\.$", "", First)), 
         Last = tolower(gsub("\\.$", "", Last)), 
         Firm = tolower(gsub("\\.$", "", Law_Firm))) %>%
  anti_join(distin_com_lawyer %>% mutate(Firm = tolower(gsub("\\.$", "", Firm)), 
                                         First = tolower(gsub("\\.$", "", First)), 
                                         Last = tolower(gsub("\\.$", "", Last))), 
            by = c("Firm" = "Firm", "First" = "First", "Last" = "Last")) %>% 
  mutate(First = str_to_title(First), Last = str_to_title(Last)) %>%
  select(-Firm)


deal_lawyer_full_no_match <- deal_lawyer_full_no_match %>%
  left_join(deal, by = c("deal" = "Deal name")) %>%
  select(deal, `Signing date`, `Closing date`, everything())

 View(deal_lawyer_full_no_match)

write_csv(x = deal_lawyer_full_no_match, file = "com_deal_lawyer_full_no_match.csv")
```

## Second confidence on no match data using first and last name

```{r}
deal_lawyer_first_last <- deal_lawyer_full_no_match %>%
  mutate(First = tolower(gsub("\\.$", "", First)), 
         Last = tolower(gsub("\\.$", "", Last))) %>%
  inner_join(distin_com_lawyer %>% mutate(First = tolower(gsub("\\.$", "", First)), 
                                          Last = tolower(gsub("\\.$", "", Last))), 
            by = c("First" = "First", "Last" = "Last")) %>% 
  mutate(First = str_to_title(First), Last = str_to_title(Last))


View(deal_lawyer_first_last)

write_csv(x = deal_lawyer_first_last, file = "com_deal_lawyer_first_last.csv")
```

## Anti-join to get no match

```{r}
deal_lawyer_first_last_no_match <- deal_lawyer_full_no_match %>%
  mutate(First = tolower(gsub("\\.$", "", First)), 
         Last = tolower(gsub("\\.$", "", Last))) %>%
  anti_join(distin_com_lawyer %>% mutate(First = tolower(gsub("\\.$", "", First)), 
                                         Last = tolower(gsub("\\.$", "", Last))), 
            by = c("First" = "First", "Last" = "Last")) %>% 
  mutate(First = str_to_title(First), Last = str_to_title(Last))


View(deal_lawyer_first_last_no_match)

write_csv(x = deal_lawyer_first_last_no_match, file = "com_deal_lawyer_first_last_no_match.csv")
```

# The thrid confidence

```{r}
deal_lawyer_firm_last <- deal_lawyer_first_last_no_match %>%
  mutate(Firm = tolower(gsub("\\.$", "", Law_Firm)), 
         Last = tolower(gsub("\\.$", "", Last))) %>%
  inner_join(distin_com_lawyer %>% mutate(Firm = tolower(gsub("\\.$", "", Firm)), 
                                          Last = tolower(gsub("\\.$", "", Last))), 
            by = c("Firm" = "Firm", "Last" = "Last")) %>% 
  mutate(Last = str_to_title(Last)) %>%
  select(-Firm)

View(deal_lawyer_firm_last)

write_csv(x = deal_lawyer_firm_last, file = "com_deal_lawyer_firm_last.csv")
```

## Anti-join to get remaining unmatched rows

```{r}
deal_lawyer_firm_last_no_match <- deal_lawyer_first_last_no_match %>%
  mutate(Firm = tolower(gsub("\\.$", "", Law_Firm)), 
         Last = tolower(gsub("\\.$", "", Last))) %>%
  anti_join(distin_com_lawyer %>% mutate(Firm = tolower(gsub("\\.$", "", Firm)), 
                                         Last = tolower(gsub("\\.$", "", Last))), 
            by = c("Firm" = "Firm", "Last" = "Last")) %>% 
  mutate(Last = str_to_title(Last)) %>%
  select(-Firm)

# View(deal_lawyer_firm_last_no_match)

write_csv(x = deal_lawyer_firm_last_no_match, file = "com_deal_lawyer_firm_last_no_match.csv")
View(deal_lawyer_firm_last_no_match)
```

# Find duplicates from first and last match

```{r}
dupli_first_last <- deal_lawyer_first_last %>%
  count(deal, First, Last) %>%
  filter(n > 1) %>%
  arrange(desc(n))

dupli_first_last <- deal_lawyer_first_last %>%
  inner_join(dupli_first_last, by = c("deal" = "deal", "First" = "First", "Last" = "Last")) %>%
  select(deal, `Signing date`, `Closing date`, First, MI.x, Last, n, everything()) 

write_csv(x = dupli_first_last, file = "duplicate_first_last.csv")
View(dupli_first_last)
```


# Find duplicates from firm and last match

```{r}
dupli_firm_last <- deal_lawyer_firm_last %>%
  count(deal, Law_Firm, Last) %>%
  filter(n > 1) %>%
  arrange(desc(n))

dupli_firm_last <- deal_lawyer_firm_last %>%
  inner_join(dupli_firm_last, by = c("deal" = "deal", "Law_Firm" = "Law_Firm", "Last" = "Last")) %>%
  select(deal, `Signing date`, `Closing date`, First.x, MI.x, Last, n, everything()) 

write_csv(x = dupli_firm_last, file = "duplicate_firm_last.csv")
View(dupli_firm_last)
```











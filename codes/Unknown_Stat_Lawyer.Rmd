---
title: "Compare missing versus non-missing Statistics"
subtitle: 'Deal and Lawyer Studies'
author: Li Yuan, li.yuan@vanderbilt.edu
date: "`r format(Sys.time(), '%d %B, %Y %H:%M:%S')`"
geometry: "left=1cm,right=1cm,top=1cm,bottom=1.4cm"
abstract: "The aim of this paper is to study correlation between missing information and industry sector, year, age, deal value. We will focus on how gender affects missing info using machine learning inference in the second half of this paper."
thanks: "Advisor: Tracey George and Albert"
toccolor: "blue"
linkcolor: "red"
documentclass: "article"
bibliography: references.bib
csl: asa.csl
output: 
  pdf_document:
    toc: true
    toc_depth: 2
    citation_package: biblatex
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, cache = T, 
                      prompt = T,
                      tidy = T,
                      fig.fullwidth=TRUE, 
                      fig.align = 'center',
                      fig.width = 15,
                      fig.height = 8,
                      attr.source='.numberLines')
```

# Load packages

```{r, message=FALSE}
library(readtext)
library(antiword)
library(tidyverse)
library(ggplot2)
library(textreadr)
library(stringi)
library(textclean)
library(SemNetCleaner)
library(readxl)
library(janitor)

library(patchwork)
library(ggrepel)
library(gghighlight)
library(paletteer)
library(ggExtra)
library(ggbeeswarm)
library(kableExtra)
library(caret)
library(randomForest)
library(corrplot)
library(lubridate)
library(babynames)
```

# Load data

```{r, message=FALSE, warning=FALSE}
deal <- read_csv("../data/deal/deal(1).csv", col_types = cols(.default = "c"))
#View(deal)

merge_deal_lawyer <- read_csv("../data/deal_lawyer/merge_deal_lawyer.csv")
#View(merge_deal_lawyer)

distin_com_lawyer <- read_csv("../data/lawyer/keep_MA_first.csv", 
    col_types = cols(.default = "c"))
#View(distin_com_lawyer)

map_index <- read_csv("../data/deal/map_index.csv")
#View(map_index)

encoded_merge_dl <- merge_deal_lawyer %>%
  left_join(map_index, by = c("deal" = "Deal_name")) %>%
  select(Deal_number, everything(), -deal) 
#View(encoded_merge_dl)

encoded_deal <- deal %>%
  left_join(map_index, by = c("Deal name" = "Deal_name")) %>%
  select(Deal_number, everything(), -`Deal name`)
#View(encoded_deal)
```


# How many lawyers are unknown (NA and “not disclosed”)? 

## Distribution of the missing and non-missing lawyers

**What is the distribution of the missing lawyers by deal value (category), year, and industry sector?  Histogram for each plus mean, standard, median.**

### Counts of Missing Lawyers

```{r echo=FALSE}
missing_number <- encoded_merge_dl %>%
  filter(is.na(First)) %>% 
  select(Deal_number) %>%
  unique() %>%
  pull()

missing_deal <- encoded_deal %>%
  filter(Deal_number %in% missing_number) %>% 
  select(Deal_number, `Industry sector`, `Deal value`, `Signing date`) %>%
  mutate(year := str_match(string = `Signing date`, pattern = "\\d\\d\\d\\d")) %>%
  mutate(value := str_extract(`Deal value`, "^\\$.*? (million|billion)")) %>%
  mutate(value1 := ifelse(grepl("million", value),
                          str_trim(str_extract(value, "\\d.*? "), "right"), 
                          as.double(str_trim(str_extract(value, "\\d.*? "), "right")) * 1000))
missing_deal$value1 <- as.double(missing_deal$value1)
```

```{r echo=FALSE}
p1_miss <- missing_deal %>%
  group_by(`Industry sector`) %>%
  count(`Industry sector`) %>%
  ggplot(aes(y = reorder(`Industry sector`, n), x = n)) +
  #geom_histogram(stat="count") #+
  geom_col(fill = "red", orientation = "y") + 
  theme_linedraw() +
  labs(x="\nIndustry Sector", y="total counts", 
       title = "Different Industry Sectors of missing lawyers") +
  theme(legend.title = element_text(size = 10), 
        legend.text = element_text(size = 10),       
        axis.text.x = element_text(size = 10),      
        axis.text.y = element_text(size = 10),       
        axis.title = element_text(size = 10),  
        plot.title = element_text(hjust = 0.5, size = 15))
p1_miss
```

### Counts of non-missing lawyers

```{r echo=FALSE}
non_missing_deal <- encoded_deal %>%
  filter(!Deal_number %in% missing_number) %>% 
  select(Deal_number, `Industry sector`, `Deal value`, `Signing date`) %>%
  mutate(year := str_match(string = `Signing date`, pattern = "\\d\\d\\d\\d")) %>%
  mutate(value := str_extract(`Deal value`, "^\\$.*? (million|billion)")) %>%
  mutate(value1 := ifelse(grepl("million", value),
                          str_trim(str_extract(value, "\\d.*? "), "right"), 
                          as.double(str_trim(str_extract(value, "\\d.*? "), "right")) * 1000))
non_missing_deal$value1 <- as.double(non_missing_deal$value1)
# View(non_missing_deal)

p1_non <- non_missing_deal %>%
  group_by(`Industry sector`) %>%
  count(`Industry sector`) %>%
  ggplot(aes(y = reorder(`Industry sector`, n), x = n)) +
  #geom_histogram(stat="count") #+
  geom_col(fill = "red", orientation = "y") + 
  theme_linedraw() +
  labs(x="\nIndustry Sector", y="total counts", 
       title = "Different Industry Sectors of non-missing lawyers") +
  theme(legend.title = element_text(size = 10), 
        legend.text = element_text(size = 10),       
        axis.text.x = element_text(size = 10),      
        axis.text.y = element_text(size = 10),       
        axis.title = element_text(size = 10),  
        plot.title = element_text(hjust = 0.5, size = 15))
p1_non
```

## Chi-Square Test of Independence 

The top 15 most industry sector among missing lawyer deals

```{r echo=FALSE}
contingency <- missing_deal %>%
  group_by(`Industry sector`) %>%
  count(`Industry sector`, sort = T) %>%
  ungroup() %>%
  top_n(15) %>%
  rename(missing := n) %>%
  inner_join(non_missing_deal %>%
  group_by(`Industry sector`) %>%
  count(`Industry sector`) %>%
  ungroup() %>%
  rename(non_missing := n), by = c("Industry sector" = "Industry sector")) %>%
  column_to_rownames(var = "Industry sector") %>% as.matrix() %>% as.table()
```

```{r}
contingency %>%
  kbl(caption = "Contingency Table of missing and non-missing lawyer deals by 15 Industry", booktabs = T) %>%
kable_styling(latex_options = c("striped", "hold_position"))
```

```{r echo=FALSE}
contingency %>% t() %>%
  mosaicplot(shade = T, las = 1, main = "Pearson's chi-squared of missing and non-missing lawyer deals by Industry", sub = "Mosaic Plot", off = 40, border = "black", type = "pearson")
```

- Blue color indicates that the observed value is higher than the expected value if the data were random
- Red color specifies that the observed value is lower than the expected value if the data were random

From this plot generated by `Pearson's chi-squared`, we can tell that `oil and gas` has more missing lawyers than expected while `oil and gas` has much lower deals of non-missing lawyers than expected.

```{r}
chisq <- chisq.test(contingency)
chisq
```

From this $p-value \approx 0$, we can tell that industry sector are missing versus non-missing are statistically significantly associated. 

If we want to know the most contributing cells to the total Chi-square score, you just have to calculate the Chi-square statistic for each cell:

$$r=\frac{o-e}{\sqrt{e}}$$
$$contrib =\frac{r^{2}}{\chi^{2}}$$
```{r include=FALSE}
# Contibution in percentage (%)
contrib <- 100*chisq$residuals^2/chisq$statistic
round(contrib, 3)
```

```{r}
# Visualize the contribution
corrplot(contrib, is.corr = FALSE, outline = T)
```

From this percentage contribution correlation plot, we can tell that `oil and gas` makes huge statistically significant to chi-squared values, which means that `oil and gas` industry sector is a main factor to determine missing versus non-missing lawyer in deals.

```{r eval=FALSE, include=FALSE}
p1_miss / p1_non
```

### Distribution and Density curve of deal values of missing lawyers

```{r echo=FALSE}
dat <- missing_deal %>%
  filter(value1 <= 5000)
colors <- c("mean" = "blue", "median" = "purple")
dat %>%
  ggplot(aes(x = value1)) +
  geom_histogram(breaks = c(seq(0, 5000, by = 50)),
                 aes(y=..density..),
                 colour="white", 
                 fill="red") +
  geom_density(alpha=.30, fill="black", color = "black") +
  geom_vline(xintercept = mean(dat$value1), lty= 2, color = "blue", lwd = 2.5) +
  geom_vline(xintercept = median(dat$value1), lty= 4, color = "purple", lwd = 2.5) +
  theme_linedraw() +
  labs(x="\nDeal Value", y="Density", 
       title = "Density and histograms for Deal Values of missing lawyers",
       color = "Legend") +
  theme(axis.text.x = element_text(size = 12),      
        axis.text.y = element_text(size = 12),       
        axis.title = element_text(size = 15),  
        plot.title = element_text(hjust = 0.5, size = 15)) +
  annotate("text", x =680, y = 0.0039, label = "mean", size = 6) +
  annotate("text", x = -100, y = 0.0039, label = "median", size = 6) +
  annotate("text", x = 1300, y = 0.0005, label = "Density Curve", size = 7)
ggsave(file="../plots/Density_missing_lawyers.pdf", width=10, height=8)
```

```{r echo=FALSE}
missing_deal <- missing_deal %>%
  mutate(type := "missing")
non_missing_deal <- non_missing_deal %>%
  mutate(type := "non_missing")
miss_non_miss <- rbind(missing_deal, non_missing_deal)
#View(miss_non_miss)
```

```{r echo=FALSE}
dat <- non_missing_deal %>%
  filter(value1 <= 5000)
colors <- c("mean" = "blue", "median" = "purple")
dat %>%
  ggplot(aes(x = value1)) +
  geom_histogram(breaks = c(seq(0, 5000, by = 50)),
                 aes(y=..density..),
                 colour="white", 
                 fill="red") +
  geom_density(alpha=.30, fill="black", color = "black") +
  geom_vline(xintercept = mean(dat$value1), lty= 2, color = "blue", lwd = 2.5) +
  geom_vline(xintercept = median(dat$value1), lty= 4, color = "purple", lwd = 2.5) +
  theme_linedraw() +
  labs(x="\nDeal Value", y="Density", 
       title = "Density and histograms for Deal Values of non-missing lawyers",
       color = "Legend") +
  theme(axis.text.x = element_text(size = 12),      
        axis.text.y = element_text(size = 12),       
        axis.title = element_text(size = 15),  
        plot.title = element_text(hjust = 0.5, size = 15)) +
  annotate("text", x =680, y = 0.0039, label = "mean", size = 6) +
  annotate("text", x = -100, y = 0.0039, label = "median", size = 6) +
  annotate("text", x = 1300, y = 0.0005, label = "Density Curve", size = 7)
ggsave(file="../plots/Density_non_missing_lawyers.pdf", width=10, height=8)
```

#### Put them together to compare

```{r echo=FALSE}
dat <- miss_non_miss %>%
  filter(value1 <= 5000)
dat %>%
  ggplot(aes(x = value1)) +
  geom_histogram(aes(y = ..density..,
                      fill = type), 
                 alpha = 0.5, 
                 breaks = c(seq(0, 5000, by = 50)), 
                 position = "identity",
                 color = "white") +
  geom_density(aes(x = value1, colour = type), lwd = 1.7, alpha = 0.5) + 
  theme_linedraw() + 
  scale_fill_manual(values = c("red", "black")) +
  scale_colour_manual(values = c("red", "black")) +
  labs(x="\nDeal Value", y="Density", 
       title = "Density and histograms for Deal Values of missing and non-missing lawyers") +
  theme(axis.text.x = element_text(size = 12),      
        axis.text.y = element_text(size = 12),       
        axis.title = element_text(size = 15),  
        plot.title = element_text(hjust = 0.5, size = 15))
ggsave(file="../plots/Density_non_missing_missing_lawyers.pdf", width=10, height=8)
```

## Two-sample Kolmogorov–Smirnov test

### Empirical distributions of deal values for missing and non-missing lawyer deals

```{r}
plot(ecdf(dat %>% filter(type == "missing") %>% pull(value1)), 
     col = "red", main = "Empirical Distribution Functions of missing and non-missing deal values",
     xlab = "Deal Value")
lines(ecdf(dat %>% filter(type == "non_missing") %>% pull(value1)), col = "blue")
legend(x = "bottomright", legend = c("Missing deal values", "Non-missing deal values"), col = c("red", "blue"), lty = c(1,1), lwd = 4, bg = "yellow",seg.len = 6, text.font = 3)
```

### Two-sample Kolmogorov–Smirnov test

The empirical distribution function $F_n$ for $n$ independent and identically distributed (i.i.d.) ordered observations $X_i$ is defined as
$$F_{n}(x)=\frac{1}{n} \sum_{i=1}^{n} I_{[-\infty, x]}\left(X_{i}\right)$$
where $I_{[-\infty, x]}\left(X_{i}\right)$ is the indicator function, equal to 1 if $X_{i} \leq x$ and equal to $0$ otherwise.

The Kolmogorov–Smirnov test may also be used to test whether two underlying one-dimensional probability distributions differ. In this case, the Kolmogorov–Smirnov statistic is
$$D_{n, m}=\sup _{x} \mid F_{1, n}(x)-F_{2, m}(x)$$ where $F_{1,n}$ and $F_{2,m}$ are the empirical distribution functions of the first and the second sample respectively, and $\sup$ is the supremum function.

```{r}
miss <- dat %>% filter(type == "missing") %>% pull(value1)
non_miss <- dat %>% filter(type == "non_missing") %>% pull(value1)
ks.test(miss, non_miss)
```

From this p-value, 0.001608, we can say that missing and non-missing lawyer deal values are from different distribution since the null hypothesis is two samples are drawn from the same distribution. However, this p-value is not too small and from the ECDF plot, they are quite close, in light of p-value isn't always reliable, so I think the distribution of missing lawyer deal values are almost very close that of non-missing counterpart.

### Mean, Median and Standard Deviation of deal values

```{r}
miss_non_miss %>%
  group_by(type) %>%
  summarise(min := min(value1, na.rm = T), 
            mean := mean(value1, na.rm = T), 
            median := median(value1, na.rm = T), 
            max := max(value1, na.rm = T),
            sd := sd(value1, na.rm = T)) %>%
  kbl(caption = "Summary Stats Table comparing missing and non-missing", booktabs = T) %>%
kable_styling(latex_options = c("striped", "hold_position"))
```

**Boxplot for missing and non-missing**

```{r}
miss_non_miss %>%
  filter(value1 <= 1500) %>%
  ggplot(aes(x = value1)) +
  geom_boxplot(aes(fill = type), 
               na.rm = F, 
               notch = T,
               varwidth = T,
               orientation = "y",
               outlier.colour = "red") +
  theme_linedraw() +
  labs(x="\nDeal Value", y="Type", 
       title = "Boxplot for Deal Values of missing and non-missing lawyers") +
  theme(axis.text.x = element_text(size = 12),      
        axis.text.y = element_text(size = 12),       
        axis.title = element_text(size = 15),  
        plot.title = element_text(hjust = 0.5, size = 15))
```

# How many law firms are unknown (NA and “not disclosed”)?    

## What is the distribution of the missing law firms by the size (in dollars) of the deal, year, and industry?  Histogram each.

### Extract corresponding dataset

```{r echo=FALSE}
missing_law_firm <- encoded_merge_dl %>%
  filter(grepl(pattern = "Not ", Law_Firm))
#View(missing_law_firm)

missing_law_firm <- encoded_deal %>%
  filter(Deal_number %in% (missing_law_firm %>% pull(Deal_number))) %>% 
  select(Deal_number, `Industry sector`, `Deal value`, `Signing date`) %>%
  mutate(year := str_match(string = `Signing date`, pattern = "\\d\\d\\d\\d")) %>%
  mutate(value := str_extract(`Deal value`, "^\\$.*? (million|billion)")) %>%
  mutate(value1 := ifelse(grepl("million", value),
                          str_trim(str_extract(value, "\\d.*? "), "right"), 
                          as.double(str_trim(str_extract(value, "\\d.*? "), "right")) * 1000))
missing_law_firm$value1 <- as.double(missing_law_firm$value1)
#View(missing_law_firm)

non_missing_law_firm <- encoded_deal %>%
  filter(!Deal_number %in% (missing_law_firm %>% pull(Deal_number))) %>% 
  select(Deal_number, `Industry sector`, `Deal value`, `Signing date`) %>%
  mutate(year := str_match(string = `Signing date`, pattern = "\\d\\d\\d\\d")) %>%
  mutate(value := str_extract(`Deal value`, "^\\$.*? (million|billion)")) %>%
  mutate(value1 := ifelse(grepl("million", value),
                          str_trim(str_extract(value, "\\d.*? "), "right"), 
                          as.double(str_trim(str_extract(value, "\\d.*? "), "right")) * 1000))
non_missing_law_firm$value1 <- as.double(non_missing_law_firm$value1)
#View(non_missing_law_firm)
```

### Bar plots for missing law firms

```{r echo=FALSE}
missing_law_firm %>%
  group_by(`Industry sector`) %>%
  count(`Industry sector`) %>%
  ggplot(aes(y = reorder(`Industry sector`, n), x = n)) +
  #geom_histogram(stat="count") #+
  geom_col(fill = "red", color = "white", orientation = "y") + 
  theme_linedraw() +
  labs(x="\nIndustry Sector", y="total counts", 
       title = "Different Industry Sectors of missing law firms") +
  theme(legend.title = element_text(size = 10), 
        legend.text = element_text(size = 10),       
        axis.text.x = element_text(size = 10),      
        axis.text.y = element_text(size = 10),       
        axis.title = element_text(size = 15),  
        plot.title = element_text(hjust = 0.5, size = 15))
```

### Bar plots for non_missing law firms

```{r echo=FALSE}
non_missing_law_firm %>%
  group_by(`Industry sector`) %>%
  count(`Industry sector`) %>%
  ggplot(aes(y = reorder(`Industry sector`, n), x = n)) +
  #geom_histogram(stat="count") #+
  geom_col(fill = "red", color = "white", orientation = "y") + 
  theme_linedraw() +
  labs(x="\nIndustry Sector", y="total counts", 
       title = "Different Industry Sectors of non-missing law firms") +
  theme(legend.title = element_text(size = 10), 
        legend.text = element_text(size = 10),       
        axis.text.x = element_text(size = 10),      
        axis.text.y = element_text(size = 10),       
        axis.title = element_text(size = 15),  
        plot.title = element_text(hjust = 0.5, size = 15))
```

### Histogram and density curves to compare them

#### Combine two dataset marked by types

```{r}
missing_law_firm <- missing_law_firm %>%
  mutate(type := "missing")
non_missing_law_firm <- non_missing_law_firm %>%
  mutate(type := "non_missing")
miss_non_miss_law_firm <- rbind(missing_law_firm, non_missing_law_firm)
#View(miss_non_miss_law_firm)
```

#### Plot it based on types

```{r echo=FALSE}
dat <- miss_non_miss_law_firm %>%
  filter(value1 <= 2500)
dat %>%
  ggplot(aes(x = value1)) +
  geom_histogram(aes(y = ..density..,
                      fill = type), 
                 alpha = 0.5, 
                 breaks = c(seq(0, 2500, by = 50)), 
                 position = "identity",
                 color = "white") +
  geom_density(aes(x = value1, colour = type), lwd = 1.7, alpha = 0.5) + 
  theme_linedraw() + 
  scale_fill_manual(values = c("red", "black")) +
  scale_colour_manual(values = c("red", "black")) +
  labs(x="\nDeal Value", y="Density", 
       title = "Density and histograms for Deal Values of missing and non-missing law firms") +
  theme(axis.text.x = element_text(size = 10),      
        axis.text.y = element_text(size = 10),       
        axis.title = element_text(size = 15),  
        plot.title = element_text(hjust = 0.5, size = 15))
ggsave(file="../plots/Density_non_missing_missing_law.pdf", width=10, height=8)
```

### Mean, Median and Standard Deviation

```{r}
miss_non_miss_law_firm %>%
  group_by(type) %>%
  summarise(min := min(value1, na.rm = T), 
            mean := mean(value1, na.rm = T), 
            median := median(value1, na.rm = T), 
            max := max(value1, na.rm = T),
            sd := sd(value1, na.rm = T)) %>%
  kbl(caption = "Summary Stats Table comparing missing and non-missing", booktabs = T) %>%
kable_styling(latex_options = c("striped", "hold_position"))
```

# How many deal attorneys are missing biographical information? 
## What is the distribution of the missing data – are these mostly from earlier years, for example?

## Load the no-matched data set

```{r, message=FALSE}
com_deal_lawyer_firm_last_no_match <- read_csv("../data/confidence_match/com_deal_lawyer_firm_last_no_match.csv")
#View(com_deal_lawyer_firm_last_no_match)
```

## attorneys without biographical info

```{r}
att_miss_bio <- com_deal_lawyer_firm_last_no_match %>%
  drop_na(First) %>%
  mutate(year := str_match(string = `Signing date`, pattern = "\\d\\d\\d\\d"))
#View(att_miss_bio)

att_miss_bio %>%
  distinct(First, Last) %>%
  nrow
```

There are 904 attorneys without biographical info.

## Distribution of Years

```{r echo=FALSE}
att_miss_bio %>%
 #distinct(First, Last, .keep_all = T) %>%
  ggplot(aes(x = year)) +
  geom_histogram(stat="count", fill = "red", width = .35) +
  labs(title = "Counts of attorneys without biograh info") +
  theme_linedraw() +
  theme(axis.text.x = element_text(size = 10),      
        axis.text.y = element_text(size = 10),       
        axis.title = element_text(size = 15),  
        plot.title = element_text(hjust = 0.5, size = 25))
```

## Distribution of deal type

```{r echo=FALSE}
p_without <- att_miss_bio %>%
   #distinct(First, Last, .keep_all = T) %>%
    ggplot(aes(x = year)) +
    geom_histogram(stat="count", aes(fill = Type), position = position_dodge2(), width = .4) +
    labs(title = "Counts of attorneys without biograh info grouped by type and year") +
    theme_linedraw() +
    theme(axis.text.x = element_text(size = 10),      
          axis.text.y = element_text(size = 10),       
          axis.title = element_text(size = 13),  
          plot.title = element_text(hjust = 0.5, size = 20),
          legend.title = element_text(size = 17),
          legend.text = element_text(size = 14))
```
## Distribution of attorneys with biograh info

```{r}
three_matched_stacked <- read_csv("../data/confidence_match/three_matched_stacked.csv", col_types = cols(.default = "c"))
#View(three_matched_stacked)

# If duplicates, keep attorneys from MA only
dis_three_matched_stacked <- three_matched_stacked %>%
  distinct(Deal_number, `Signing date`, First, Last, Law_Firm, .keep_all = T)
#View(dis_three_matched_stacked)
```

```{r echo=FALSE}
p_with <- dis_three_matched_stacked %>%
  #distinct(First, Last, `JD Year`, `Law School`, Undergrad, Gender, Race, .keep_all = T) %>%
  select(Deal_number, `Signing date`, First, MI.x, Last, Source, Type) %>%
  mutate(year := str_match(string = `Signing date`, pattern = "\\d\\d\\d\\d")) %>%
  ggplot(aes(x = year)) +
  geom_histogram(stat="count", aes(fill = Type), position = position_dodge2(), width = .4) +
  labs(title = "Counts of attorneys with biograh info grouped by type and year") +
  theme_linedraw() +
  theme(axis.text.x = element_text(size = 10),      
        axis.text.y = element_text(size = 10),       
        axis.title = element_text(size = 13),  
        plot.title = element_text(hjust = 0.5, size = 20),
        legend.title = element_text(size = 17),
        legend.text = element_text(size = 14))
```

## Compare them together

```{r}
p_with / p_without
```

## Two time series by months of counts of attorneys with and without biograh info

```{r echo=FALSE}
dis_three_matched_stacked %>%
  select(Deal_number, `Signing date`, First, MI.x, Last, Source, Type) %>%
  mutate(date1 := as.Date(`Signing date`, format = "%B %d, %Y")) %>% 
  mutate(date2 := format(date1, "%Y-%m")) %>% 
  mutate(date3 := ym(date2)) %>%
  group_by(date3) %>%
  count() %>% 
  ungroup() %>%
  rename("non_missing" := n) %>%
  inner_join(att_miss_bio  %>%
          mutate(date1 := as.Date(`Signing date`, format = "%B %d, %Y")) %>% 
          mutate(date2 := format(date1, "%Y-%m")) %>% 
          mutate(date3 := ym(date2)) %>%
          group_by(date3) %>%
          count() %>% 
          ungroup() %>% 
          rename("missing" := n), by = "date3") %>%
  pivot_longer(cols = c("non_missing", "missing"), names_to = "type", values_to = "n") %>%
  ggplot(aes(x = date3, y = n, col = type)) +
  geom_line(lwd = 1.2) + 
  geom_point(cex = 3) +
  geom_smooth(method = "loess", formula = "y~x", show.legend = T) +
  xlab("") +
  theme(axis.text.x=element_text(angle=60, hjust=1)) +
  scale_x_date(date_breaks = "4 months") +
  theme_linedraw() + 
  labs(title = "Two Time Series of Counts of attorneys with/without biograh by month",
       y = "Count") +
  theme_light() +
  theme(axis.text.x = element_text(size = 15, angle = 70, vjust = 0.5),      
        axis.text.y = element_text(size = 15),       
        axis.title = element_text(size = 13),  
        plot.title = element_text(hjust = 0.5, size = 23),
        legend.title = element_text(size = 17),
        legend.text = element_text(size = 14))
```

From these two time series by month, we can tell numbers of attorneys with/without biograh info have very close trend but absolute number. The missing number is less than non-missing number, but they have the same trend. From the `loess` fitted line, we can tell that non-missing group has much fluctuation than missing group.

# How many deals are missing attorneys’ biographical information?

```{r}
att_miss_bio %>%
  distinct(Deal_number) %>%
  nrow()
```

There are 1139 deals without attorneys' biograh info.

## Counts of deals without attorneys' biograh info grouped by Year and Deal Type.

```{r echo=FALSE}
p_without <- att_miss_bio %>%
  distinct(Deal_number, .keep_all = T) %>%
  ggplot(aes(x = year)) +
  geom_histogram(stat="count", aes(fill = Type), position = position_dodge2(), width = .4) +
  labs(title = "Counts of deals without attorney biograh info grouped by type and year") +
  theme_linedraw() +
  theme(axis.text.x = element_text(size = 10),      
        axis.text.y = element_text(size = 10),       
        axis.title = element_text(size = 13),  
        plot.title = element_text(hjust = 0.5, size = 13))

p_with <- dis_three_matched_stacked %>%
  distinct(Deal_number, .keep_all = T) %>%
  mutate(year := str_match(string = `Signing date`, pattern = "\\d\\d\\d\\d")) %>%
  ggplot(aes(x = year)) +
  geom_histogram(stat="count", aes(fill = Type), position = position_dodge2(), width = .4) +
  labs(title = "Counts of deals with attorneys biograh info grouped by type and year") +
  theme_linedraw() +
  theme(axis.text.x = element_text(size = 10),      
        axis.text.y = element_text(size = 10),       
        axis.title = element_text(size = 13),  
        plot.title = element_text(hjust = 0.5, size = 13))
p_without / p_with
```

# Create some summary tables

**Create a summary table of the number of deals, gender breakdown, age distribution (of lawyers appearing on the deal); school distribution (i.e., most common law school attended), law firm distribution (i.e., most common law firms appearing on the deal); types of deals (e.g., health care; financial services, etc.); size of deal**

## Number of deals, gender, age

### a summary table of the number of deals, gender breakdown, age distribution (of lawyers appearing on the deal)

**We consider 25 years old as average ages when students graduate from law school.**

```{r echo=FALSE}
dis_three_matched_stacked$`JD Year` <- 
  as.integer(dis_three_matched_stacked$`JD Year`, "%Y")
```

```{r echo=FALSE}
dis_three_matched_stacked <- dis_three_matched_stacked %>%
  mutate(age := 25 + 2021 - `JD Year`)
```

```{r echo=FALSE}
dis_three_matched_stacked <- dis_three_matched_stacked %>%
  mutate(age_breaks := case_when(
    age <= 30 ~ "age <= 30",
    age > 30 & age <= 45 ~ "30 < age <= 45",
    age > 45 & age <= 60 ~ "45 < age <= 60",
    age > 60 ~ "age > 60"
  ))
```

```{r}
dis_three_matched_stacked %>%
  drop_na(Gender, age_breaks) %>%
  group_by(Gender, age_breaks) %>%
  count() %>% 
  arrange(desc(n)) %>%
  ungroup() %>%
  mutate(percentage := round(n / sum(n) * 100, 2)) %>%
  kbl(caption = "Summary Stats Table of Attorneys with Biograph", 
      booktabs = T) %>%
kable_styling(latex_options = c("striped", "hold_position"))
```

## school and law distribution

### school distribution (i.e., most common law school attended), law firm distribution (i.e., most common law firms appearing on the deal)

**Please see attachment csv file for full list data here.**
```{r}
dis_three_matched_stacked %>%
  drop_na(Gender, `Law School`) %>%
  group_by(`Law School`, Law_Firm) %>% 
  count() %>% 
  arrange(desc(n)) %>% 
  write_csv(file = "../data/deal_lawyer/distri_law_sch_firm.csv")
```

```{r echo=FALSE}
dis_three_matched_stacked %>%
  drop_na(Gender, `Law School`) %>%
  group_by(`Law School`, Law_Firm) %>% 
  count() %>% 
  arrange(desc(n)) %>%
  ungroup(`Law School`, Law_Firm) %>%
  mutate(Percentage := round(n / sum(n) * 100, 2)) %>%
  head(30) %>%
  kbl(caption = "Top 30 most law school and law firm attended", booktabs = T) %>%
  kable_styling(latex_options = c("striped", "hold_position"))
```

```{r}
dis_three_matched_stacked %>%
  drop_na(Gender, `Law School`) %>%
  group_by(Gender, `Law School`) %>%
  count() %>%
  arrange(desc(n)) %>%
  ungroup(Gender, `Law School`) %>%
  top_n(50) %>%
ggplot(aes(y = reorder(`Law School`, n), x = n)) +
  geom_col(position = position_dodge2(), 
           width = .4,
           orientation = "y",
           aes(fill = Gender)) +
  labs(title = "Counts of lawyers grouped by gender and law school",
       y = "Counts") +
  theme_linedraw() +
  theme(axis.text.x = element_text(size = 10),      
        axis.text.y = element_text(size = 10),       
        axis.title = element_text(size = 15),  
        plot.title = element_text(hjust = 0.5, size = 15))
```

## types of deals

### types of deals (e.g., health care; financial services, etc.); size of deal

```{r echo=FALSE}
dis_three_matched_stacked$Deal_number <- 
  as.integer(dis_three_matched_stacked$Deal_number)
```

```{r echo=FALSE}
type_value_deal <- dis_three_matched_stacked %>%
  left_join(encoded_deal, by = c("Deal_number" = "Deal_number")) %>%
  select(Deal_number, First, Last, Law_Firm, Type, `Industry sector`, `Deal value`) %>% 
  mutate(value := str_extract(`Deal value`, "^\\$.*? (million|billion)")) %>%
  mutate(value1 := ifelse(grepl("million", value),
                          str_trim(str_extract(value, "\\d.*? "), "right"), 
                          as.double(str_trim(str_extract(value, "\\d.*? "), "right")) * 1000))
```

```{r}
type_value_deal %>%
  group_by(`Industry sector`) %>%
  count(sort = T) %>%
  ungroup(`Industry sector`) %>%
  mutate(percentage := round(n / sum(n) * 100, 2)) %>%
  filter(n >= 10) %>%
  kbl(caption = "Industry Sector Count and Percentage", booktabs = T) %>%
kable_styling(latex_options = c("striped", "hold_position"))
```

```{r}
type_value_deal %>%
  drop_na(value1) %>%
  mutate(value_breaks := case_when(
    value1 <= 250 ~ "value <= 250",
    value1 > 250 & value1 <= 500 ~ "250 < value <= 500",
    value1 > 500 & value1 <= 1500 ~ "500 < value <= 1500",
    value1 > 1500 ~ "1500 < value"
  )) %>%
  group_by(Type, value_breaks) %>%
  count(sort = T) %>%
  ungroup() %>%
  mutate(percentage := round(n / sum(n) * 100, 2)) %>%
  kbl(caption = "Counts of deals grouped by types and value\\_breaks", booktabs = T) %>%
kable_styling(latex_options = c("striped", "hold_position"))
```

## Buyer and seller of deals

### Breakdown by buyer and seller in the deals. We think that law firms and M&A lawyers appear on both sides of the deal with roughly the same probability, but it would be helpful to know if this were true.

```{r}
encoded_merge_dl %>%
  group_by(Law_Firm, Type) %>%
  count(sort = T) %>%
  ungroup(Law_Firm, Type) %>%
  filter(n >= 50) %>%
  ggplot(aes(y = reorder(Law_Firm, n), x = n)) +
  geom_col(position = position_dodge2(), 
           width = .4,
           orientation = "y",
           aes(fill = Type)) +
  labs(title = "Counts of law firms grouped by buyer and seller",
       y = "Counts") +
  theme_linedraw() +
  theme(axis.text.x = element_text(size = 10),      
        axis.text.y = element_text(size = 10),       
        axis.title = element_text(size = 15),  
        plot.title = element_text(hjust = 0.5, size = 15))
```

```{r}
dis_three_matched_stacked %>%
  filter(Source == "M&A") %>%
  count(Type, sort = T) %>%
  kbl(caption = "MA Lawyers grouped by Buyer/Seller", booktabs = T) %>%
  kable_styling(latex_options = c("striped", "hold_position"))
```

# Regression Analysis on Gender

**Some basic regressions: e.g., regress gender on observable characteristics (e.g., firm, industry, size of deal). Explain what factors explain when women are more likely to appear on a deal.**

## First we used Multiple Logistic Regression with all variables

```{r echo=FALSE}
dat <- dis_three_matched_stacked %>%
  inner_join(encoded_deal, by = c("Deal_number" = "Deal_number")) %>%
  select(Gender, Law_Firm, Type, `Law School`, 
         ProbabilityOfMove, age, `Industry sector`, `Deal value`) %>%
  mutate(value := str_extract(`Deal value`, "^\\$.*? (million|billion)")) %>%
  mutate(value1 := ifelse(grepl("million", value),
                          str_trim(str_extract(value, "\\d.*? "), "right"), 
                          as.double(str_trim(str_extract(value, "\\d.*? "), "right")) * 1000))
dat$value1 <- as.double(dat$value1)
dat <- dat %>%
  select(Gender, Law_Firm, Type, `Law School`, 
         ProbabilityOfMove, age, `Industry sector`, value1)
dat$Gender <- factor(dat$Gender, levels = c("Male", "Female"), labels = c("Male", "Female"))
dat$ProbabilityOfMove <- as.double(dat$ProbabilityOfMove)
```

```{r}
logit <- glm(Gender ~ ., data = dat, family='binomial')
```

```{r echo=FALSE}
varImp(logit) %>% arrange(desc(Overall)) %>% 
  rownames_to_column(var = "variable") %>%
  top_n(30) %>%
  ggplot(aes(y = reorder(variable, Overall), x = Overall)) +
  geom_col(position = position_dodge2(), 
           width = .4,
           orientation = "y",
           fill = "red",
           color = "white") +
  labs(title = "Variable Importance by logistic regression on Gender",
       y = "Importance") +
  theme_linedraw() +
  theme(axis.text.x = element_text(size = 10),      
        axis.text.y = element_text(size = 10),       
        axis.title = element_text(size = 15),  
        plot.title = element_text(hjust = 0.5, size = 18))
```

```{r echo=FALSE}
data.frame(Coef = logit$coefficients) %>%
  rownames_to_column(var = "variable") %>%
  arrange(desc(Coef)) %>% 
  top_n(10) %>%
  ggplot(aes(y = reorder(variable, Coef), x = Coef)) +
  geom_col(position = position_dodge2(), 
           width = .4,
           orientation = "y",
           fill = "red",
           color = "white") +
  labs(title = "Variable Coefficients by logistic regression on Gender",
       y = "Importance") +
  theme_linedraw() +
  theme(axis.text.x = element_text(size = 10),      
        axis.text.y = element_text(size = 18),       
        axis.title = element_text(size = 20),  
        plot.title = element_text(hjust = 0.5, size = 22))
```

### age coefficients

```{r}
data.frame(Coef = logit$coefficients) %>%
  rownames_to_column(var = "variable") %>%
  filter(variable == "age")
```

### Law_school coefficient signs

```{r}
data.frame(Coef = logit$coefficients) %>%
  rownames_to_column(var = "variable") %>%
  filter(grepl("Law School", variable)) %>%
  filter(Coef > 0) %>% nrow

data.frame(Coef = logit$coefficients) %>%
  rownames_to_column(var = "variable") %>%
  filter(grepl("Law School", variable)) %>%
  filter(Coef < 0) %>% nrow
```

### Law_Firm coefficient signs

```{r}
data.frame(Coef = logit$coefficients) %>%
  rownames_to_column(var = "variable") %>%
  filter(grepl("Law_Firm", variable)) %>%
  filter(Coef > 0) %>% nrow

data.frame(Coef = logit$coefficients) %>%
  rownames_to_column(var = "variable") %>%
  filter(grepl("Law_Firm", variable)) %>%
  filter(Coef < 0) %>% nrow
```

### Industry Sector coefficient signs

```{r}
data.frame(Coef = logit$coefficients) %>%
  rownames_to_column(var = "variable") %>%
  filter(grepl("Industry", variable)) %>%
  filter(Coef > 0) %>% nrow

data.frame(Coef = logit$coefficients) %>%
  rownames_to_column(var = "variable") %>%
  filter(grepl("Industry", variable)) %>%
  filter(Coef < 0) %>% nrow
```

## Multiple Logistic Regression with all variables except for Law Schol and Law firm

```{r echo=FALSE}
logit1 <- glm(Gender ~ . - Law_Firm - `Law School`, data = dat, family='binomial')
varImp(logit1) %>% arrange(desc(Overall)) %>% 
  rownames_to_column(var = "variable") %>%
  top_n(30) %>%
  ggplot(aes(y = reorder(variable, Overall), x = Overall)) +
  geom_col(position = position_dodge2(), 
           width = .4,
           orientation = "y",
           fill = "red",
           color = "white") +
  labs(title = "Variable Importance by logistic regression on Gender",
       y = "Importance") +
  theme_linedraw() +
  theme(axis.text.x = element_text(size = 10),      
        axis.text.y = element_text(size = 10),       
        axis.title = element_text(size = 15),  
        plot.title = element_text(hjust = 0.5, size = 18))
```
## Random Forest with the whole variables used

```{r}
dat <- dat %>% rename(Law_school = `Law School`, Industry_sector=`Industry sector`)
rand <- randomForest(Gender ~ . , data = dat, na.action = na.omit)
```

### Variable Importance after fitting our model

```{r echo=FALSE}
varImp(rand) %>%
  rownames_to_column(var = "variable") %>%
  ggplot(aes(y = reorder(variable, Overall), x = Overall)) +
  geom_col(position = position_dodge2(), 
           width = .4,
           orientation = "y",
           fill = "red",
           color = "white") +
  labs(title = "Variable Importance by Random Forest on Gender",
       y = "Importance") +
  theme_linedraw() +
  theme(axis.text.x = element_text(size = 10),      
        axis.text.y = element_text(size = 20),       
        axis.title = element_text(size = 20),  
        plot.title = element_text(hjust = 0.5, size = 22))
```

## Conclusion

**From two method, Logistic Classification and Random Forest, we can tell that Age, Law_Firm, Law_school are obvious significant when predicting Gender. From huge positive coefficients bar plots, at least we can tell that Law_SchoolMeMPhis can make more likely Women on the deals. And age is another huge negative affects which can make huge Adverse conditions for women appearing on Deals. Deal Value and Type(buyer/Seller) aren't significant variables affecting women.**

As for other law_school and law_firm coefficients, there are both positive and negative coefficients affecting women showing on Deals. 

1. In total, there are 128 Law_school coefficients greater than 0, while 18 Law_school lower than 0, which means Law_school in general make positive affects on women showing on Deals.
2. However, there are 174 Law_Firm coefficients greater than 0, while 296 Law_Firm lower than 0, which means Law_Firm in general make negative affects on women showing on Deals.
3. There are 17 Industrial coefficients greater than 0, while 30 Industrial sector lower than 0, which means Industrial Sector in general make negative affects on women showing on Deals.

# Predict Gender for attorneys without biograh info

```{r, warning=F, message=FALSE}
name_gender_dataset <- read_csv("../data/gender/name_gender_dataset.csv")
#View(name_gender_dataset)
```

We collect baby names from 1940 to 1990 provided by SSA since this year range covers most lawyer birth years.

```{r include=FALSE}
name_1940_1990 <- babynames %>%
  filter(1990 >= year & year >= 1940) %>% 
  group_by(name, sex) %>%
  summarise(total := sum(n)) %>% 
  ungroup() %>%
  arrange(desc(total))

app_1940_1990 <- applicants %>%
  filter(1990 >= year & year >= 1940) %>%
  group_by(sex) %>%
  summarise(total1 := sum(n_all)) %>%
  ungroup()

name_1940_1990 <- name_1940_1990 %>%
  inner_join(app_1940_1990, by = "sex") %>%
  mutate(prop := total / total1) %>%
  group_by(name) %>%
  mutate(prop1 := total / sum(total)) %>%
  arrange(prop1) %>%
  filter(prop1 >= 0.25) %>%
  group_by(name) %>%
  mutate(sex1 := case_when(
    n() == 1 ~ sex,
    n() == 2 ~ "unclear"
  )) %>%
  distinct(name, sex1, .keep_all = T) %>%
  select(name, sex1, prop1)
```

## We displayed top 10 rows.

```{r}
head(name_1940_1990,10) %>%
  kbl(caption = "Baby Names from 1940 to 1990 provided by SSA", booktabs = T) %>% 
  kable_styling(latex_options = c("striped", "hold_position"))
```

```{r}
gender_UCI <- name_gender_dataset %>%
  group_by(Name) %>%
  mutate(prop := Count / sum(Count)) %>%
  filter(prop >= 0.25) %>%
  group_by(Name) %>%
  mutate(sex := case_when(
    n() == 1 ~ Gender,
    n() == 2 ~ "unclear"
  )) %>%
  distinct(Name, sex, .keep_all = T) %>%
  select(Name, sex, prop)
```

We used `Gender by Name Data Set` from https://archive.ics.uci.edu/ml/datasets/Gender+by+Name# as the supplementary to teh first babynames data. We displayed top 10 rows.

```{r}
head(gender_UCI, 10) %>%
  kbl(caption = "Names and Genders from provided by UCI", booktabs = T) %>% 
  kable_styling(latex_options = c("striped", "hold_position"))
```

We match attorney without biograh info using these two new gender prediction by first name dataset.

```{r}
att_miss_with_gender <- att_miss_bio %>%
  left_join(name_1940_1990, by = c("First" = "name")) %>% 
  left_join(gender_UCI, by = c("First" = "Name")) %>%
  mutate(gender := case_when(
    is.na(sex1) ~ sex,
    !is.na(sex1) ~ sex1
  ))
```

## Make some plots on Gender

```{r echo=FALSE}
att_miss_with_gender %>%
  drop_na(gender) %>%
  group_by(gender) %>%
  count() %>%
  ggplot(aes(x = reorder(gender, -n), y = n)) +
  geom_col(fill = "red", width = .1) +
  labs(title = "Counts of gender on attorneys without biograh info",
       y = "Counts", x = "") +
  theme_linedraw() +
  theme(axis.text.x = element_text(size = 20),      
        axis.text.y = element_text(size = 20),       
        axis.title = element_text(size = 20),  
        plot.title = element_text(hjust = 0.5, size = 25))
```

From this plot we can tell that male are dominant without bigraph info.

## Two-Proportions Z-Test of Gender between missing versus non-missing

The two-proportions z-test is used to compare two observed proportions. We want to know whether the proportions of female are the same in the two groups , missing biograph versus non-missing biograph?

Let's pull up gender counts in attorneys with biograph info.

```{r}
dis_three_matched_stacked %>%
  drop_na(Gender) %>%
  group_by(Gender) %>%
  count() %>%
  kbl(caption = "Gender Counts of attorneys with biograph", booktabs = T) %>% 
  kable_styling(latex_options = c("striped", "hold_position"))
```

### Research questions

**Whether the observed proportion of females in group missing (Pm) is equal to the observed proportion of females in group non-missing (Pnm)?**
$$H_{0}: P_{m}=P_{nm}$$
$$H_{a}: P_{m} \neq P_{nm} \;\;(\text{different})$$

The z-test statistics can be calculated as follow:
$$z=\frac{P_{m}-P_{nm}}{\sqrt{p q / n_{m}+p q / n_{nm}}}$$
where $p$ and $q$ are the overall proportions.

### Form a contingency table

```{r echo=FALSE}
att_miss_with_gender %>%
  drop_na(gender) %>%
  group_by(gender) %>%
  count() %>%
  mutate(Gender := case_when(
    gender == "F" ~ "Female",
    gender == "M" ~ "Male"
  )) %>%
  ungroup() %>%
  rename(missing := n) %>%
  inner_join(
  dis_three_matched_stacked %>%
  drop_na(Gender) %>%
  group_by(Gender) %>%
  count() %>%
  rename(non_missing := n), by = "Gender") %>%
  select(Gender, missing, non_missing) %>%
  kbl(caption = "Gender Counts by missing versus non missing", booktabs = T) %>% 
  kable_styling(latex_options = c("striped", "hold_position"))
```

```{r}
prop.test(x = c(194, 579), n = c(194 + 1126, 579 + 4766))
```

**The p-value of the test is 0.000105, which is less than the significance level $\alpha = 0.05$. We can conclude that the proportion of female is significantly different in the two groups with a p-value = 0.000105. The female proportion estimate of missing group is about 0.1469 which is greater than that of non-missing group, 0.1083. We can say that there are missing female biograph than non-missing.**

Thanks for [@RCoreTeam], [@rstudio], [@Chang2015], [@ggplot2], [@tidyverse], [@stringi], [@kableExtra], [@caret], [@randomForest], [@babynames] and gender prediction dataset from UCI [@Dua:2019]